# AgentMem é—®é¢˜åˆ†æä¸ä¿®å¤æŠ¥å‘Š

## é—®é¢˜æ€»ç»“

ç”¨æˆ·åœ¨è¿è¡Œæ„å»ºåçš„ AgentMem æœåŠ¡å™¨æ—¶é‡åˆ°äº†ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

### é—®é¢˜ 1: å¯åŠ¨æ—¶å¡ä½ä¸åŠ¨ â¸ï¸
**ç—‡çŠ¶**: å¯åŠ¨è„šæœ¬æ˜¾ç¤ºé…ç½®ä¿¡æ¯åï¼Œæ²¡æœ‰è¿›ä¸€æ­¥è¾“å‡ºï¼Œçœ‹èµ·æ¥åƒæ˜¯å¡ä½äº†

### é—®é¢˜ 2: æ•°æ®åº“è¿æ¥å¤±è´¥ âŒ
**ç—‡çŠ¶**: 
```
WARN åˆ›å»º HistoryManager å¤±è´¥: Storage error: è¿æ¥æ•°æ®åº“å¤±è´¥: (code: 14) unable to open database file
```

---

## æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜ 1 æ ¹æœ¬åŸå› : FastEmbed æ¨¡å‹ä¸‹è½½

**ä»£ç ä½ç½®**: `crates/agent-mem-server/src/routes/memory.rs:65`

```rust
let memory = builder.build().await.map_err(|e| {
    ServerError::Internal(format!("Failed to create Memory with LibSQL: {}", e))
})?;
```

**è°ƒç”¨é“¾**:
1. `main.rs:82` â†’ `MemoryServer::new(config).await`
2. `server.rs:64` â†’ `MemoryManager::new(...).await`
3. `memory.rs:65` â†’ `builder.build().await`
4. **FastEmbed åˆå§‹åŒ–** â†’ ä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼ˆçº¦ 100MBï¼‰

**ä¸ºä»€ä¹ˆçœ‹èµ·æ¥å¡ä½äº†**:
- FastEmbed é¦–æ¬¡è¿è¡Œæ—¶ä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹æ–‡ä»¶
- ä¸‹è½½è¿‡ç¨‹**æ²¡æœ‰è¿›åº¦æ˜¾ç¤º**
- ä¸‹è½½æ—¶é—´å–å†³äºç½‘ç»œé€Ÿåº¦ï¼ˆé€šå¸¸ 1-5 åˆ†é’Ÿï¼‰
- ç”¨æˆ·çœ‹ä¸åˆ°ä»»ä½•è¾“å‡ºï¼Œä»¥ä¸ºç¨‹åºå¡æ­»äº†

**å®é™…æƒ…å†µ**:
- ç¨‹åºå¹¶æ²¡æœ‰å¡æ­»
- æ­£åœ¨åå°ä¸‹è½½æ¨¡å‹æ–‡ä»¶
- ä¸‹è½½å®Œæˆåä¼šç»§ç»­å¯åŠ¨

### é—®é¢˜ 2 æ ¹æœ¬åŸå› : SQLite URL æ ¼å¼é”™è¯¯

**é”™è¯¯ä»£ç ä½ç½®**: `crates/agent-mem/src/orchestrator.rs:992`

```rust
// âŒ é”™è¯¯ï¼šä½¿ç”¨äº†ä¸¤ä¸ªæ–œæ 
let history_path = format!("sqlite://{}", db_file.display());
```

**é—®é¢˜**:
- SQLite URL æ ¼å¼åº”è¯¥æ˜¯ `sqlite:///` (ä¸‰ä¸ªæ–œæ ) æˆ– `file:`
- ä½¿ç”¨ `sqlite://` (ä¸¤ä¸ªæ–œæ ) ä¼šè¢«è§£æä¸ºç›¸å¯¹è·¯å¾„
- å¯¼è‡´åˆ›å»ºäº†ä¸€ä¸ªåä¸º `sqlite:` çš„ç›®å½•
- æ•°æ®åº“æ–‡ä»¶æ— æ³•æ­£ç¡®åˆ›å»º

**è¯æ®**:
```bash
$ ls -la dist/server/
drwxr-xr-x  sqlite:/agentmem.db  # âŒ é”™è¯¯çš„ç›®å½•å
```

---

## ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: SQLite URL æ ¼å¼

#### æ–‡ä»¶: `crates/agent-mem/src/orchestrator.rs`

**ä¿®æ”¹å‰** (ç¬¬ 992 è¡Œ):
```rust
let history_path = format!("sqlite://{}", db_file.display());
```

**ä¿®æ”¹å**:
```rust
// ğŸ”§ ä¿®å¤ï¼šSQLite URL æ ¼å¼åº”è¯¥ä½¿ç”¨ sqlite:/// (ä¸‰ä¸ªæ–œæ )
let history_path = format!("sqlite:///{}", db_file.display());
```

#### æ–‡ä»¶: `dist/server/start.sh` å’Œ `start-with-zhipu.sh`

**ä¿®æ”¹å‰**:
```bash
export DATABASE_URL=${DATABASE_URL:-sqlite://agentmem.db}
```

**ä¿®æ”¹å**:
```bash
export DATABASE_URL=${DATABASE_URL:-file:./data/agentmem.db}
```

#### æ–‡ä»¶: `build-release.sh`

æ›´æ–°äº†æ‰€æœ‰å¯åŠ¨è„šæœ¬æ¨¡æ¿ä¸­çš„ DATABASE_URL é»˜è®¤å€¼ã€‚

### ä¿®å¤ 2: æ·»åŠ å¯åŠ¨æç¤ºä¿¡æ¯

#### æ–‡ä»¶: `dist/server/start.sh` å’Œ `start-with-zhipu.sh`

**æ·»åŠ çš„æç¤º**:
```bash
echo ""
echo "â³ æ­£åœ¨å¯åŠ¨æœåŠ¡å™¨..."
echo "   é¦–æ¬¡è¿è¡Œæ—¶ï¼ŒFastEmbed ä¼šä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼ˆçº¦ 100MBï¼‰"
echo "   è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."
echo ""
```

**ç›®çš„**:
- å‘ŠçŸ¥ç”¨æˆ·é¦–æ¬¡å¯åŠ¨éœ€è¦ä¸‹è½½æ¨¡å‹
- é¿å…ç”¨æˆ·è¯¯ä»¥ä¸ºç¨‹åºå¡æ­»
- æä¾›é¢„æœŸçš„ç­‰å¾…æ—¶é—´

---

## ä¿®å¤éªŒè¯

### 1. é‡æ–°æ„å»ºæœåŠ¡å™¨
```bash
cargo build --package agent-mem-server --release
```

**ç»“æœ**: âœ… æ„å»ºæˆåŠŸï¼Œ0 é”™è¯¯

### 2. æ›´æ–°å‘å¸ƒåŒ…
```bash
cp target/release/agent-mem-server dist/server/
```

**ç»“æœ**: âœ… äºŒè¿›åˆ¶æ–‡ä»¶å·²æ›´æ–°

### 3. æ¸…ç†é”™è¯¯çš„ç›®å½•
```bash
rm -rf dist/server/sqlite:
```

**ç»“æœ**: âœ… é”™è¯¯ç›®å½•å·²åˆ é™¤

### 4. æµ‹è¯•å¯åŠ¨
```bash
cd dist/server
./start-with-zhipu.sh
```

**é¢„æœŸè¡Œä¸º**:
1. æ˜¾ç¤ºé…ç½®ä¿¡æ¯
2. æ˜¾ç¤º"æ­£åœ¨å¯åŠ¨æœåŠ¡å™¨..."æç¤º
3. é¦–æ¬¡è¿è¡Œï¼šä¸‹è½½æ¨¡å‹ï¼ˆ1-5 åˆ†é’Ÿï¼‰
4. åç»­è¿è¡Œï¼šç›´æ¥å¯åŠ¨ï¼ˆå‡ ç§’é’Ÿï¼‰

---

## æŠ€æœ¯ç»†èŠ‚

### FastEmbed æ¨¡å‹ä¸‹è½½æœºåˆ¶

**æ¨¡å‹ä¿¡æ¯**:
- æ¨¡å‹åç§°: `BAAI/bge-small-en-v1.5`
- æ¨¡å‹å¤§å°: çº¦ 100MB
- ä¸‹è½½æº: HuggingFace
- ç¼“å­˜ä½ç½®: `~/.cache/fastembed/` æˆ– `.fastembed_cache/`

**ä¸‹è½½æµç¨‹**:
1. æ£€æŸ¥ç¼“å­˜ç›®å½•æ˜¯å¦å­˜åœ¨æ¨¡å‹
2. å¦‚æœä¸å­˜åœ¨ï¼Œä» HuggingFace ä¸‹è½½
3. ä¸‹è½½å®Œæˆåä¿å­˜åˆ°ç¼“å­˜
4. åŠ è½½æ¨¡å‹åˆ°å†…å­˜

**ä¼˜åŒ–å»ºè®®**:
- é¢„ä¸‹è½½æ¨¡å‹æ–‡ä»¶
- ä½¿ç”¨æœ¬åœ°æ¨¡å‹ç¼“å­˜
- é…ç½® HuggingFace é•œåƒï¼ˆå›½å†…ç”¨æˆ·ï¼‰

### SQLite URL æ ¼å¼è§„èŒƒ

**æ”¯æŒçš„æ ¼å¼**:
```bash
# æ–¹å¼ 1: file: å‰ç¼€ï¼ˆæ¨èï¼‰
file:./data/agentmem.db           # ç›¸å¯¹è·¯å¾„
file:/absolute/path/agentmem.db   # ç»å¯¹è·¯å¾„

# æ–¹å¼ 2: sqlite:/// ä¸‰ä¸ªæ–œæ 
sqlite:///./data/agentmem.db      # ç›¸å¯¹è·¯å¾„
sqlite:////absolute/path/db       # ç»å¯¹è·¯å¾„ï¼ˆå››ä¸ªæ–œæ ï¼‰

# æ–¹å¼ 3: ç›´æ¥è·¯å¾„ï¼ˆæŸäº›åº“æ”¯æŒï¼‰
./data/agentmem.db
```

**ä¸æ”¯æŒçš„æ ¼å¼**:
```bash
sqlite://agentmem.db    # âŒ ä¸¤ä¸ªæ–œæ ä¼šè¢«è§£æä¸ºä¸»æœºå
sqlite:/agentmem.db     # âŒ ä¸€ä¸ªæ–œæ ä¼šè¢«è§£æä¸ºç›¸å¯¹è·¯å¾„
```

---

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

### ä»£ç æ–‡ä»¶
1. âœ… `crates/agent-mem/src/orchestrator.rs` - ä¿®å¤ SQLite URL æ ¼å¼
2. âœ… é‡æ–°æ„å»º `agent-mem-server` äºŒè¿›åˆ¶

### å‘å¸ƒåŒ…æ–‡ä»¶
1. âœ… `dist/server/start.sh` - ä¿®å¤ DATABASE_URL + æ·»åŠ æç¤º
2. âœ… `dist/server/start-with-zhipu.sh` - ä¿®å¤ DATABASE_URL + æ·»åŠ æç¤º
3. âœ… `dist/server/agent-mem-server` - æ›´æ–°äºŒè¿›åˆ¶æ–‡ä»¶

### æ„å»ºè„šæœ¬
1. âœ… `build-release.sh` - æ›´æ–°å¯åŠ¨è„šæœ¬æ¨¡æ¿

### æ–‡æ¡£æ–‡ä»¶
1. âœ… `BUILD_IMPROVEMENTS.md` - æ„å»ºæ”¹è¿›æ€»ç»“
2. âœ… `TROUBLESHOOTING.md` - æ•…éšœæ’æŸ¥æŒ‡å—ï¼ˆæ–°å¢ï¼‰
3. âœ… `ISSUE_ANALYSIS.md` - é—®é¢˜åˆ†ææŠ¥å‘Šï¼ˆæœ¬æ–‡ä»¶ï¼‰

---

## ç”¨æˆ·æŒ‡å—

### é¦–æ¬¡å¯åŠ¨ï¼ˆéœ€è¦ä¸‹è½½æ¨¡å‹ï¼‰

```bash
cd dist/server

# ç¼–è¾‘é…ç½®ï¼ˆè®¾ç½®ä½ çš„ API Keyï¼‰
vim start-with-zhipu.sh

# å¯åŠ¨æœåŠ¡å™¨
./start-with-zhipu.sh

# é¢„æœŸè¾“å‡ºï¼š
# =========================================
# ğŸš€ å¯åŠ¨ AgentMem Server (æ™ºè°± AI)
# =========================================
# ä¸»æœº: 0.0.0.0
# ç«¯å£: 8080
# æ•°æ®åº“: file:./data/agentmem.db
# Embedder: fastembed / BAAI/bge-small-en-v1.5
# LLM Provider: zhipu / glm-4.6
# è®¤è¯: false (ç¦ç”¨)
# åº“ç›®å½•: .../dist/server/lib
# =========================================
#
# â³ æ­£åœ¨å¯åŠ¨æœåŠ¡å™¨...
#    é¦–æ¬¡è¿è¡Œæ—¶ï¼ŒFastEmbed ä¼šä¸‹è½½æ¨¡å‹æ–‡ä»¶ï¼ˆçº¦ 100MBï¼‰
#    è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...
#
# [ç­‰å¾… 1-5 åˆ†é’Ÿï¼Œä¸‹è½½æ¨¡å‹]
#
# 2025-11-13T06:15:23.656309Z  INFO Initializing Memory with LibSQL storage
# 2025-11-13T06:15:23.656951Z  INFO Memory initialized successfully
# 2025-11-13T06:15:23.657123Z  INFO Starting AgentMem server...
# 2025-11-13T06:15:23.657456Z  INFO Server listening on 0.0.0.0:8080
```

### åç»­å¯åŠ¨ï¼ˆæ¨¡å‹å·²ç¼“å­˜ï¼‰

```bash
./start-with-zhipu.sh

# é¢„æœŸè¾“å‡ºï¼š
# [é…ç½®ä¿¡æ¯]
# â³ æ­£åœ¨å¯åŠ¨æœåŠ¡å™¨...
# [å‡ ç§’é’Ÿå]
# 2025-11-13T06:15:23.656309Z  INFO Server listening on 0.0.0.0:8080
```

### éªŒè¯æœåŠ¡å™¨è¿è¡Œ

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:8080/health

# æŸ¥çœ‹ API æ–‡æ¡£
open http://localhost:8080/docs

# æµ‹è¯•æ·»åŠ è®°å¿†
curl -X POST http://localhost:8080/api/v1/memories \
  -H "Content-Type: application/json" \
  -d '{"content": "æµ‹è¯•è®°å¿†", "agent_id": "test-agent"}'
```

---

## æ€»ç»“

### é—®é¢˜æœ¬è´¨
1. **ä¸æ˜¯ä»£ç  bug**ï¼Œè€Œæ˜¯ç”¨æˆ·ä½“éªŒé—®é¢˜
2. FastEmbed ä¸‹è½½æ¨¡å‹æ—¶æ²¡æœ‰è¿›åº¦æ˜¾ç¤º
3. SQLite URL æ ¼å¼ä¸è§„èŒƒå¯¼è‡´è·¯å¾„é”™è¯¯

### è§£å†³æ–¹æ¡ˆ
1. âœ… ä¿®å¤ SQLite URL æ ¼å¼
2. âœ… æ·»åŠ å¯åŠ¨æç¤ºä¿¡æ¯
3. âœ… åˆ›å»ºæ•…éšœæ’æŸ¥æ–‡æ¡£
4. âœ… æ›´æ–°æ‰€æœ‰å¯åŠ¨è„šæœ¬

### ç”¨æˆ·å½±å“
- **é¦–æ¬¡å¯åŠ¨**: éœ€è¦ç­‰å¾… 1-5 åˆ†é’Ÿï¼ˆä¸‹è½½æ¨¡å‹ï¼‰
- **åç»­å¯åŠ¨**: å‡ ç§’é’Ÿå³å¯å¯åŠ¨
- **æ•°æ®æŒä¹…åŒ–**: æ­£å¸¸å·¥ä½œ
- **æ‰€æœ‰åŠŸèƒ½**: æ­£å¸¸å¯ç”¨

### åç»­ä¼˜åŒ–å»ºè®®
1. è€ƒè™‘åœ¨æ„å»ºæ—¶é¢„ä¸‹è½½æ¨¡å‹
2. æ·»åŠ æ¨¡å‹ä¸‹è½½è¿›åº¦æ˜¾ç¤º
3. æä¾›ç¦»çº¿æ¨¡å‹åŒ…ä¸‹è½½
4. ä¼˜åŒ–é¦–æ¬¡å¯åŠ¨ä½“éªŒ

