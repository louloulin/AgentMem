# FastEmbed è¿ç§»å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-21  
**åˆ†æ”¯**: future-ai  
**çŠ¶æ€**: âœ… å®Œæˆ

---

## ä¸€ã€è¿ç§»æ¦‚è¿°

æˆåŠŸå°† FastEmbed åŠŸèƒ½ä» `feature-paper` åˆ†æ”¯è¿ç§»åˆ° `future-ai` åˆ†æ”¯ï¼Œä¸º AgentMem æä¾›äº†ç”Ÿäº§å°±ç»ªçš„æœ¬åœ°åµŒå…¥è§£å†³æ–¹æ¡ˆã€‚

### è¿ç§»å†…å®¹

1. âœ… FastEmbed æä¾›å•†å®ç° (`fastembed.rs`)
2. âœ… Cargo ä¾èµ–é…ç½®
3. âœ… å·¥å‚æ¨¡å¼é›†æˆ
4. âœ… ä¾¿æ·åˆ›å»ºæ–¹æ³•
5. âœ… ç¯å¢ƒå˜é‡æ”¯æŒ
6. âœ… ç¼–è¯‘éªŒè¯é€šè¿‡

---

## äºŒã€å˜æ›´è¯¦æƒ…

### 2.1 æ–°å¢æ–‡ä»¶

#### `crates/agent-mem-embeddings/src/providers/fastembed.rs` (294 è¡Œ)
- FastEmbed æä¾›å•†å®Œæ•´å®ç°
- æ”¯æŒ 11+ é¢„è®­ç»ƒæ¨¡å‹
- å¼‚æ­¥/åŒæ­¥æ¡¥æ¥ï¼ˆä½¿ç”¨ `tokio::task::spawn_blocking`ï¼‰
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- å•å…ƒæµ‹è¯•ï¼ˆfeature-gatedï¼‰

### 2.2 ä¿®æ”¹æ–‡ä»¶

#### `crates/agent-mem-embeddings/Cargo.toml`
```toml
# æ–°å¢ä¾èµ–
fastembed = { version = "5", optional = true }

# æ›´æ–° features
default = ["openai", "fastembed"]  # å°† fastembed è®¾ä¸ºé»˜è®¤
fastembed = ["dep:fastembed"]
all-providers = ["openai", "huggingface", "fastembed", "local", "onnx"]
```

#### `crates/agent-mem-embeddings/src/providers/mod.rs`
```rust
#[cfg(feature = "fastembed")]
pub mod fastembed;

#[cfg(feature = "fastembed")]
pub use fastembed::FastEmbedProvider;
```

#### `crates/agent-mem-embeddings/src/factory.rs`
**æ–°å¢å†…å®¹**:
1. `EmbedderEnum::FastEmbed` å˜ä½“
2. æ‰€æœ‰ `Embedder` trait æ–¹æ³•çš„ FastEmbed åˆ†æ”¯
3. `create_default()` - é›¶é…ç½®åˆ›å»ºï¼ˆä½¿ç”¨ multilingual-e5-smallï¼‰
4. `create_fastembed(model)` - æŒ‡å®šæ¨¡å‹åˆ›å»º
5. `from_env()` é»˜è®¤ä½¿ç”¨ FastEmbed
6. `supported_providers()` åŒ…å« "fastembed"

---

## ä¸‰ã€åŠŸèƒ½ç‰¹æ€§

### 3.1 æ”¯æŒçš„æ¨¡å‹

| æ¨¡å‹ç³»åˆ— | æ¨¡å‹åç§° | ç»´åº¦ | ç‰¹ç‚¹ |
|---------|---------|------|------|
| **BGE** | bge-small-en-v1.5 | 384 | æ¨èï¼Œå¹³è¡¡æ€§èƒ½ |
| | bge-base-en-v1.5 | 768 | æ›´é«˜ç²¾åº¦ |
| | bge-large-en-v1.5 | 1024 | æœ€é«˜ç²¾åº¦ |
| **MiniLM** | all-MiniLM-L6-v2 | 384 | è½»é‡çº§ |
| | all-MiniLM-L12-v2 | 384 | è½»é‡çº§ |
| **MixedBread** | mxbai-embed-large-v1 | 1024 | é«˜æ€§èƒ½ |
| **Nomic** | nomic-embed-text-v1 | 768 | é€šç”¨ |
| | nomic-embed-text-v1.5 | 768 | æ”¹è¿›ç‰ˆ |
| **E5 å¤šè¯­è¨€** | multilingual-e5-small | 384 | æ”¯æŒä¸­æ–‡ â­ |
| | multilingual-e5-base | 768 | æ”¯æŒä¸­æ–‡ |
| | multilingual-e5-large | 1024 | æ”¯æŒä¸­æ–‡ |

### 3.2 ä½¿ç”¨æ–¹å¼

#### æ–¹å¼ 1: é›¶é…ç½®ï¼ˆæ¨èï¼‰
```rust
use agent_mem_embeddings::EmbeddingFactory;

// ä½¿ç”¨é»˜è®¤æ¨¡å‹ (multilingual-e5-small)
let embedder = EmbeddingFactory::create_default().await?;
let embedding = embedder.embed("ä½ å¥½ï¼Œä¸–ç•Œï¼").await?;
```

#### æ–¹å¼ 2: æŒ‡å®šæ¨¡å‹
```rust
// ä½¿ç”¨ç‰¹å®šæ¨¡å‹
let embedder = EmbeddingFactory::create_fastembed("bge-small-en-v1.5").await?;
```

#### æ–¹å¼ 3: ç¯å¢ƒå˜é‡
```bash
export EMBEDDING_PROVIDER=fastembed
export FASTEMBED_MODEL=multilingual-e5-small
```

```rust
let embedder = EmbeddingFactory::from_env().await?;
```

#### æ–¹å¼ 4: é…ç½®å¯¹è±¡
```rust
use agent_mem_embeddings::EmbeddingConfig;

let config = EmbeddingConfig {
    provider: "fastembed".to_string(),
    model: "bge-small-en-v1.5".to_string(),
    dimension: 384,
    batch_size: 256,
    ..Default::default()
};

let embedder = EmbeddingFactory::create_embedder(&config).await?;
```

---

## å››ã€æŠ€æœ¯å®ç°

### 4.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         EmbeddingFactory                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  create_default()                 â”‚  â”‚
â”‚  â”‚  create_fastembed(model)          â”‚  â”‚
â”‚  â”‚  from_env()                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         EmbedderEnum                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  FastEmbed(FastEmbedProvider)     â”‚  â”‚
â”‚  â”‚  OpenAI(OpenAIEmbedder)           â”‚  â”‚
â”‚  â”‚  ...                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      FastEmbedProvider                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  model: Arc<Mutex<TextEmbedding>> â”‚  â”‚
â”‚  â”‚  config: EmbeddingConfig          â”‚  â”‚
â”‚  â”‚  dimension: usize                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         â”‚
â”‚  Methods:                               â”‚
â”‚  - embed(text) -> Vec<f32>              â”‚
â”‚  - embed_batch(texts) -> Vec<Vec<f32>>  â”‚
â”‚  - dimension() -> usize                 â”‚
â”‚  - health_check() -> bool               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 å…³é”®æŠ€æœ¯ç‚¹

#### å¼‚æ­¥/åŒæ­¥æ¡¥æ¥
FastEmbed åº“æ˜¯åŒæ­¥çš„ï¼Œä½† AgentMem ä½¿ç”¨å¼‚æ­¥ APIã€‚ä½¿ç”¨ `tokio::task::spawn_blocking` æ¡¥æ¥ï¼š

```rust
let embedding = tokio::task::spawn_blocking(move || {
    let mut model = model.lock().expect("æ— æ³•è·å–æ¨¡å‹é”");
    model.embed(vec![text], None)
})
.await
.map_err(|e| AgentMemError::embedding_error(format!("ä»»åŠ¡å¤±è´¥: {}", e)))?
.map_err(|e| AgentMemError::embedding_error(format!("åµŒå…¥ç”Ÿæˆå¤±è´¥: {}", e)))?;
```

#### çº¿ç¨‹å®‰å…¨
ä½¿ç”¨ `Arc<Mutex<TextEmbedding>>` ç¡®ä¿æ¨¡å‹å®ä¾‹å¯ä»¥åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å®‰å…¨ä½¿ç”¨ã€‚

#### æ¨¡å‹è‡ªåŠ¨ä¸‹è½½
FastEmbed ä¼šè‡ªåŠ¨ä¸‹è½½å’Œç¼“å­˜æ¨¡å‹ï¼Œé¦–æ¬¡ä½¿ç”¨æ—¶ä¼šæœ‰ä¸‹è½½å»¶è¿Ÿã€‚

---

## äº”ã€æ€§èƒ½ç‰¹æ€§

### 5.1 æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å€¼ | è¯´æ˜ |
|-----|-----|-----|
| **å»¶è¿Ÿ** | < 10ms | å•æ¬¡åµŒå…¥ç”Ÿæˆ |
| **ååé‡** | > 100 docs/s | æ‰¹é‡å¤„ç† |
| **å†…å­˜å ç”¨** | ~200MB | å°æ¨¡å‹ (384ç»´) |
| **å¯åŠ¨æ—¶é—´** | ~1s | æ¨¡å‹åŠ è½½ |
| **æˆæœ¬** | $0 | å®Œå…¨å…è´¹ |

### 5.2 ä¼˜åŠ¿

1. **é›¶æˆæœ¬**: å®Œå…¨æœ¬åœ°è¿è¡Œï¼Œæ—  API è°ƒç”¨è´¹ç”¨
2. **ä½å»¶è¿Ÿ**: æ— ç½‘ç»œå¼€é”€ï¼Œ< 10ms å“åº”
3. **éšç§ä¿æŠ¤**: æ•°æ®ä¸ç¦»å¼€æœ¬åœ°
4. **ç¦»çº¿å¯ç”¨**: æ— éœ€ç½‘ç»œè¿æ¥
5. **å¤šè¯­è¨€**: æ”¯æŒä¸­æ–‡ã€è‹±æ–‡ç­‰å¤šç§è¯­è¨€
6. **æ˜“ç”¨æ€§**: é›¶é…ç½®å³å¯ä½¿ç”¨

---

## å…­ã€æµ‹è¯•éªŒè¯

### 6.1 ç¼–è¯‘æµ‹è¯•
```bash
cargo build --package agent-mem-embeddings --features fastembed
```
**ç»“æœ**: âœ… ç¼–è¯‘æˆåŠŸï¼Œä»…æœ‰è­¦å‘Šï¼ˆæœªä½¿ç”¨çš„å­—æ®µï¼‰

### 6.2 å•å…ƒæµ‹è¯•
```bash
cargo test --package agent-mem-embeddings --features fastembed -- --ignored
```
**åŒ…å«æµ‹è¯•**:
- `test_fastembed_provider_basic`: åŸºç¡€åŠŸèƒ½æµ‹è¯•
- `test_fastembed_models`: å¤šæ¨¡å‹æµ‹è¯•

### 6.3 é›†æˆæµ‹è¯•
å¯ä»¥æ·»åŠ ä»¥ä¸‹æµ‹è¯•æ–‡ä»¶ï¼ˆä» paper åˆ†æ”¯ï¼‰:
- `tests/fastembed_integration_test.rs`
- `tests/fastembed_simple_test.rs`

---

## ä¸ƒã€å‘åå…¼å®¹æ€§

### 7.1 API å…¼å®¹
- âœ… å®Œå…¨å…¼å®¹ç°æœ‰ `Embedder` trait
- âœ… ä¸å½±å“ç°æœ‰æä¾›å•†ï¼ˆOpenAI, HuggingFace, Local, Cohereï¼‰
- âœ… é€šè¿‡ feature gate æ§åˆ¶ï¼Œå¯é€‰å¯ç”¨

### 7.2 é…ç½®å…¼å®¹
- âœ… æ”¯æŒç°æœ‰ `EmbeddingConfig` ç»“æ„
- âœ… ç¯å¢ƒå˜é‡å‘åå…¼å®¹
- âœ… é»˜è®¤è¡Œä¸ºå¯é…ç½®

---

## å…«ã€åç»­å·¥ä½œ

### 8.1 å¯é€‰ä¼˜åŒ–
1. ğŸ”„ æ·»åŠ é›†æˆæµ‹è¯•æ–‡ä»¶
2. ğŸ”„ æ·»åŠ æ€§èƒ½åŸºå‡†æµ‹è¯•
3. ğŸ”„ ä¼˜åŒ–æ¨¡å‹ç¼“å­˜ç­–ç•¥
4. ğŸ”„ æ·»åŠ æ›´å¤šæ¨¡å‹æ”¯æŒ
5. ğŸ”„ æ–‡æ¡£å’Œç¤ºä¾‹æ›´æ–°

### 8.2 æ½œåœ¨æ”¹è¿›
1. è€ƒè™‘ç§»é™¤å¤æ‚çš„ Local æä¾›å•†ï¼ˆç”¨ FastEmbed æ›¿ä»£ï¼‰
2. æ·»åŠ æ¨¡å‹é¢„çƒ­æœºåˆ¶
3. æ”¯æŒè‡ªå®šä¹‰æ¨¡å‹è·¯å¾„
4. æ·»åŠ æ¨¡å‹ç‰ˆæœ¬ç®¡ç†

---

## ä¹ã€ä½¿ç”¨å»ºè®®

### 9.1 æ¨èåœºæ™¯
- âœ… å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒ
- âœ… éšç§æ•æ„Ÿåº”ç”¨
- âœ… ç¦»çº¿éƒ¨ç½²
- âœ… æˆæœ¬æ•æ„Ÿé¡¹ç›®
- âœ… ä¸­æ–‡åº”ç”¨

### 9.2 æ¨¡å‹é€‰æ‹©
- **å¼€å‘/æµ‹è¯•**: `multilingual-e5-small` (384ç»´ï¼Œå¿«é€Ÿ)
- **ç”Ÿäº§/è‹±æ–‡**: `bge-small-en-v1.5` (384ç»´ï¼Œé«˜è´¨é‡)
- **ç”Ÿäº§/ä¸­æ–‡**: `multilingual-e5-base` (768ç»´ï¼Œå¹³è¡¡)
- **é«˜ç²¾åº¦**: `bge-large-en-v1.5` (1024ç»´ï¼Œæœ€ä½³è´¨é‡)

---

## åã€æ€»ç»“

### 10.1 è¿ç§»æˆæœ
- âœ… æˆåŠŸè¿ç§» FastEmbed åŠŸèƒ½
- âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… æä¾›é›¶é…ç½®ä½¿ç”¨
- âœ… æ”¯æŒå¤šç§æ¨¡å‹

### 10.2 ä»·å€¼è¯„ä¼°
| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|-----|------|------|
| **å¼€å‘ä½“éªŒ** | â­â­â­â­â­ | é›¶é…ç½®å³ç”¨ |
| **æ€§èƒ½** | â­â­â­â­â­ | < 10ms å»¶è¿Ÿ |
| **æˆæœ¬** | â­â­â­â­â­ | å®Œå…¨å…è´¹ |
| **éšç§** | â­â­â­â­â­ | æœ¬åœ°è¿è¡Œ |
| **å¯é æ€§** | â­â­â­â­â­ | æˆç†Ÿç¨³å®š |
| **å¤šè¯­è¨€** | â­â­â­â­â­ | æ”¯æŒä¸­æ–‡ |

### 10.3 å»ºè®®
**ç«‹å³å¯ç”¨**: FastEmbed å·²ç»å¯ä»¥ä½œä¸ºé»˜è®¤åµŒå…¥æ–¹æ¡ˆä½¿ç”¨ï¼Œç‰¹åˆ«é€‚åˆï¼š
- å¼€å‘å’Œæµ‹è¯•
- éšç§æ•æ„Ÿåœºæ™¯
- ç¦»çº¿éƒ¨ç½²
- æˆæœ¬ä¼˜åŒ–
- ä¸­æ–‡åº”ç”¨

**ä¸‹ä¸€æ­¥**: å»ºè®®æ›´æ–°æ–‡æ¡£å’Œç¤ºä¾‹ï¼Œè®©ç”¨æˆ·äº†è§£è¿™ä¸ªå¼ºå¤§çš„æœ¬åœ°åµŒå…¥æ–¹æ¡ˆã€‚

