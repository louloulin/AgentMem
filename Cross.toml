# Cross 工具配置文件
# 用于配置交叉编译环境

[target.x86_64-unknown-linux-gnu]
# 使用官方 Docker 镜像（cross 会自动处理 pre-build）
image = "ghcr.io/cross-rs/x86_64-unknown-linux-gnu:main"
# 强制使用 Docker（即使目标平台与主机相同）
xargo = false

# 在容器中安装 OpenSSL 开发库（pre-build 在构建前执行）
# 创建包装脚本，在构建时自动设置环境变量
pre-build = [
    "apt-get update",
    "apt-get install -y libssl-dev pkg-config || true",
    "echo '#!/bin/sh' > /usr/local/bin/cargo-wrapper && echo 'export AWS_LC_SYS_SKIP_COMPILER_CHECK=1' >> /usr/local/bin/cargo-wrapper && echo 'exec /usr/local/cargo/bin/cargo \"$@\"' >> /usr/local/bin/cargo-wrapper && chmod +x /usr/local/bin/cargo-wrapper || true",
    "echo 'export AWS_LC_SYS_SKIP_COMPILER_CHECK=1' >> /root/.bashrc || true",
]

# 环境变量（代理配置和其他构建选项）
[target.x86_64-unknown-linux-gnu.env]
passthrough = [
    "HTTP_PROXY",
    "HTTPS_PROXY",
    "ALL_PROXY",
    "http_proxy",
    "https_proxy",
    "all_proxy",
]
# 设置构建环境变量（禁用 aws-lc-sys 的编译器检查）
AWS_LC_SYS_SKIP_COMPILER_CHECK = "1"

# 构建配置
[build]
# 使用 Docker 构建（不回退到主机 cargo）
default-target = "x86_64-unknown-linux-gnu"
