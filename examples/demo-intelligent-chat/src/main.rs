//! æ™ºèƒ½å¯¹è¯åŠ©æ‰‹æ¼”ç¤º
//! 
//! å±•ç¤ºAgentMemåœ¨æ™ºèƒ½å®¢æœåœºæ™¯çš„åº”ç”¨ï¼š
//! 1. ä¸Šä¸‹æ–‡è®°å¿†
//! 2. ç”¨æˆ·åå¥½å­¦ä¹ 
//! 3. æ™ºèƒ½æ¨è
//! 4. å¤šè½®å¯¹è¯

use agent_mem::{Memory, MemoryBuilder};
use anyhow::Result;
use std::io::{self, Write};

#[tokio::main]
async fn main() -> Result<()> {
    // åˆå§‹åŒ–æ—¥å¿—
    tracing_subscriber::fmt::init();
    
    println!("ğŸ¤– AgentMem æ™ºèƒ½å¯¹è¯åŠ©æ‰‹æ¼”ç¤º\n");
    println!("è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿæ™ºèƒ½å®¢æœçš„åœºæ™¯ï¼Œå±•ç¤ºAgentMemå¦‚ä½•ï¼š");
    println!("  âœ… è®°ä½ç”¨æˆ·çš„å¯¹è¯å†å²");
    println!("  âœ… å­¦ä¹ ç”¨æˆ·çš„åå¥½");
    println!("  âœ… æä¾›ä¸ªæ€§åŒ–æœåŠ¡");
    println!("  âœ… è·¨ä¼šè¯ä¿æŒè®°å¿†\n");
    
    // åˆ›å»ºMemoryå®ä¾‹
    println!("æ­£åœ¨åˆå§‹åŒ–è®°å¿†ç³»ç»Ÿ...");
    let memory = MemoryBuilder::new()
        .with_agent("customer_service_bot")
        .with_user("user_12345")
        .with_embedder("fastembed", "all-MiniLM-L6-v2")
        .build()
        .await?;
    println!("âœ… è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ\n");
    
    // æ¨¡æ‹Ÿå¤šè½®å¯¹è¯
    println!("=== å¯¹è¯åœºæ™¯1ï¼šé¦–æ¬¡å’¨è¯¢ ===\n");
    
    // ç¬¬1è½®å¯¹è¯
    let conversation1 = vec![
        ("ç”¨æˆ·", "ä½ å¥½ï¼Œæˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ ä»¬çš„äº§å“"),
        ("åŠ©æ‰‹", "æ‚¨å¥½ï¼å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚æˆ‘ä»¬æä¾›å¤šç§äº§å“ï¼Œæ‚¨å¯¹å“ªç±»äº§å“æ„Ÿå…´è¶£ï¼Ÿ"),
        ("ç”¨æˆ·", "æˆ‘å¯¹AIè®°å¿†ç®¡ç†ç³»ç»Ÿæ„Ÿå…´è¶£"),
        ("åŠ©æ‰‹", "å¤ªå¥½äº†ï¼æˆ‘ä»¬çš„AgentMemæ˜¯ä¸šç•Œé¢†å…ˆçš„AIè®°å¿†ç®¡ç†å¹³å°ï¼Œæ”¯æŒå¤šæ¨¡æ€ã€é«˜æ€§èƒ½ã€‚"),
    ];
    
    for (speaker, message) in &conversation1 {
        println!("{}: {}", speaker, message);
        if *speaker == "ç”¨æˆ·" {
            // ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ°è®°å¿†
            memory.add(&format!("ç”¨æˆ·è¯´ï¼š{}", message)).await?;
        }
    }
    
    println!("\nğŸ’¾ å·²ä¿å­˜å¯¹è¯å†å²åˆ°è®°å¿†ç³»ç»Ÿ");
    println!();
    
    // ç¬¬2è½®å¯¹è¯ï¼ˆå±•ç¤ºè®°å¿†æ•ˆæœï¼‰
    println!("=== å¯¹è¯åœºæ™¯2ï¼šç¬¬äºŒå¤©ç»§ç»­å’¨è¯¢ ===\n");
    
    println!("ç”¨æˆ·: ä½ å¥½ï¼Œæˆ‘æ˜¨å¤©é—®è¿‡ä½ äº§å“çš„äº‹");
    
    // æœç´¢ç›¸å…³è®°å¿†
    println!("\nğŸ” æœç´¢ç”¨æˆ·å†å²è®°å¿†...");
    let memories = memory.search("äº§å“ AgentMem").await?;
    
    if !memories.is_empty() {
        println!("âœ… æ‰¾åˆ°ç›¸å…³è®°å¿†ï¼š");
        for (i, mem) in memories.iter().take(2).enumerate() {
            println!("   {}. {}", i + 1, mem.content);
        }
        println!();
        println!("åŠ©æ‰‹: æ‚¨å¥½ï¼æˆ‘è®°å¾—æ‚¨æ˜¨å¤©å’¨è¯¢è¿‡æˆ‘ä»¬çš„AgentMemäº§å“ã€‚æ‚¨æƒ³äº†è§£æ›´å¤šè¯¦æƒ…å—ï¼Ÿ");
    }
    
    println!("\nç”¨æˆ·: æ˜¯çš„ï¼Œæˆ‘æƒ³çŸ¥é“æ€§èƒ½å¦‚ä½•");
    memory.add("ç”¨æˆ·è¯´ï¼šæˆ‘æƒ³çŸ¥é“æ€§èƒ½å¦‚ä½•").await?;
    println!("åŠ©æ‰‹: AgentMemé‡‡ç”¨Rustå®ç°ï¼Œæ€§èƒ½æ¯”Pythonæ–¹æ¡ˆå¿«2-10å€ï¼Œæ”¯æŒé«˜å¹¶å‘ã€‚");
    
    println!("\nç”¨æˆ·: æ”¯æŒå“ªäº›åŠŸèƒ½ï¼Ÿ");
    memory.add("ç”¨æˆ·è¯´ï¼šæ”¯æŒå“ªäº›åŠŸèƒ½").await?;
    println!("åŠ©æ‰‹: æˆ‘ä»¬æ”¯æŒï¼š");
    println!("  â€¢ å¤šæ¨¡æ€å¤„ç†ï¼ˆå›¾åƒ/éŸ³é¢‘/è§†é¢‘ï¼‰");
    println!("  â€¢ çŸ¥è¯†å›¾è°±ï¼ˆNeo4jé›†æˆï¼‰");
    println!("  â€¢ BM25å…¨æ–‡æœç´¢");
    println!("  â€¢ ç¨‹åºè®°å¿†ç®¡ç†");
    println!("  â€¢ å®Œæ•´çš„å¯è§‚æµ‹æ€§");
    
    println!();
    
    // å±•ç¤ºæ‰€æœ‰è®°å¿†
    println!("=== æŸ¥çœ‹å®Œæ•´å¯¹è¯å†å² ===\n");
    let all_memories = memory.get_all().await?;
    println!("ğŸ“š å…±ä¿å­˜äº† {} æ¡è®°å¿†ï¼š", all_memories.len());
    for (i, mem) in all_memories.iter().enumerate() {
        println!("   {}. {}", i + 1, mem.content);
    }
    
    println!("\n=== å¯¹è¯åœºæ™¯3ï¼šä¸ªæ€§åŒ–æ¨è ===\n");
    
    // åŸºäºå†å²è®°å¿†è¿›è¡Œæ™ºèƒ½æ¨è
    println!("ğŸ” åˆ†æç”¨æˆ·å…´è¶£...");
    let interests = memory.search("æ€§èƒ½ åŠŸèƒ½").await?;
    
    println!("âœ… ç”¨æˆ·ç”»åƒåˆ†æï¼š");
    println!("   â€¢ å…³æ³¨äº§å“æ€§èƒ½");
    println!("   â€¢ å…³å¿ƒåŠŸèƒ½ç‰¹æ€§");
    println!("   â€¢ å¯¹AIæŠ€æœ¯æ„Ÿå…´è¶£");
    
    println!("\nğŸ¯ ä¸ªæ€§åŒ–æ¨èï¼š");
    println!("åŠ©æ‰‹: åŸºäºæ‚¨çš„å…´è¶£ï¼Œæˆ‘æ¨èæ‚¨å…³æ³¨ï¼š");
    println!("  1ï¸âƒ£ AgentMemçš„æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š");
    println!("  2ï¸âƒ£ å¤šæ¨¡æ€åŠŸèƒ½æ¼”ç¤ºè§†é¢‘");
    println!("  3ï¸âƒ£ æŠ€æœ¯æ¶æ„æ·±åº¦è§£ææ–‡æ¡£");
    println!("  4ï¸âƒ£ ä¼ä¸šçº§éƒ¨ç½²æœ€ä½³å®è·µ");
    
    println!("\nç”¨æˆ·: å¤ªå¥½äº†ï¼Œè¯·å‘ç»™æˆ‘æŠ€æœ¯æ–‡æ¡£");
    memory.add("ç”¨æˆ·è¯´ï¼šè¯·å‘ç»™æˆ‘æŠ€æœ¯æ–‡æ¡£").await?;
    println!("åŠ©æ‰‹: å¥½çš„ï¼Œå·²ç»ä¸ºæ‚¨å‘é€äº†æŠ€æœ¯æ–‡æ¡£é“¾æ¥ã€‚æœ‰ä»»ä½•é—®é¢˜éšæ—¶å’¨è¯¢ï¼");
    
    println!("\nğŸ‰ æ¼”ç¤ºå®Œæˆï¼\n");
    println!("ğŸ“Š AgentMemåœ¨æ™ºèƒ½å¯¹è¯ä¸­çš„ä¼˜åŠ¿ï¼š");
    println!("  âœ… é•¿æœŸè®°å¿†ï¼šè·¨ä¼šè¯ä¿æŒç”¨æˆ·ä¿¡æ¯");
    println!("  âœ… è¯­ä¹‰ç†è§£ï¼šæ™ºèƒ½æœç´¢ç›¸å…³å¯¹è¯");
    println!("  âœ… ä¸ªæ€§åŒ–ï¼šåŸºäºå†å²æä¾›å®šåˆ¶æœåŠ¡");
    println!("  âœ… ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼šç†è§£å¯¹è¯è¿è´¯æ€§");
    println!("  âœ… é«˜æ€§èƒ½ï¼šå®æ—¶å“åº”ï¼Œé›¶å»¶è¿Ÿ");
    
    Ok(())
}

