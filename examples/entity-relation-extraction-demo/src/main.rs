//! å®ä½“å’Œå…³ç³»æå–æ¼”ç¤º
//!
//! æ­¤ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ AgentMem çš„å®ä½“å’Œå…³ç³»æå–åŠŸèƒ½ï¼š
//! - ä»æ–‡æœ¬ä¸­æå–å®ä½“ï¼ˆäººç‰©ã€ç»„ç»‡ã€åœ°ç‚¹ç­‰ï¼‰
//! - ä»æ–‡æœ¬ä¸­æå–å…³ç³»ï¼ˆå·¥ä½œäºã€ä½äºã€å–œæ¬¢ç­‰ï¼‰
//! - æ„å»ºçŸ¥è¯†å›¾è°±

use agent_mem_core::extraction::{
    EntityExtractor, RelationExtractor, RuleBasedExtractor, RuleBasedRelationExtractor,
};
use std::time::Instant;

#[tokio::main]
async fn main() -> anyhow::Result<()> {
    // åˆå§‹åŒ–æ—¥å¿—
    tracing_subscriber::fmt().with_env_filter("info").init();

    println!("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘          AgentMem å®ä½“å’Œå…³ç³»æå–æ¼”ç¤º                                  â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    // åˆ›å»ºæå–å™¨
    let entity_extractor = RuleBasedExtractor::new();
    let relation_extractor = RuleBasedRelationExtractor::new();

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ç¤ºä¾‹ 1: åŸºç¡€å®ä½“æå–
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("1ï¸âƒ£  åŸºç¡€å®ä½“æå–");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let text1 =
        "æˆ‘å«å¼ ä¸‰ï¼Œåœ¨åŒ—äº¬çš„è°·æ­Œå…¬å¸å·¥ä½œã€‚æˆ‘çš„é‚®ç®±æ˜¯zhangsan@google.comï¼Œç”µè¯æ˜¯13800138000ã€‚";

    let start = Instant::now();
    let entities = entity_extractor.extract_entities(text1).await?;
    let duration = start.elapsed();

    println!("ğŸ“ è¾“å…¥æ–‡æœ¬:");
    println!("   {text1}");
    println!();
    println!(
        "âœ… æå–åˆ° {} ä¸ªå®ä½“ï¼ˆè€—æ—¶: {:?}ï¼‰:",
        entities.len(),
        duration
    );
    for entity in &entities {
        println!(
            "   - {} [{}] (ç½®ä¿¡åº¦: {:.2})",
            entity.name,
            entity.entity_type.as_str(),
            entity.confidence
        );
    }
    println!();

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ç¤ºä¾‹ 2: å…³ç³»æå–
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("2ï¸âƒ£  å…³ç³»æå–");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let start = Instant::now();
    let relations = relation_extractor
        .extract_relations(text1, &entities)
        .await?;
    let duration = start.elapsed();

    println!(
        "âœ… æå–åˆ° {} ä¸ªå…³ç³»ï¼ˆè€—æ—¶: {:?}ï¼‰:",
        relations.len(),
        duration
    );
    for relation in &relations {
        println!(
            "   - {} [{}] {} (ç½®ä¿¡åº¦: {:.2})",
            relation.subject, relation.predicate, relation.object, relation.confidence
        );
    }
    println!();

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ç¤ºä¾‹ 3: å¤æ‚æ–‡æœ¬æå–
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("3ï¸âƒ£  å¤æ‚æ–‡æœ¬æå–");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let text2 = "æå››åœ¨ä¸Šæµ·çš„é˜¿é‡Œå·´å·´å…¬å¸å·¥ä½œï¼Œä»–å–œæ¬¢ç¼–ç¨‹å’Œæ—…æ¸¸ã€‚\
                 ä»–çš„åŒäº‹ç‹äº”åœ¨æ­å·çš„è…¾è®¯å…¬å¸ä»»èŒã€‚\
                 ä»–ä»¬éƒ½æ‹¥æœ‰ä¸°å¯Œçš„è½¯ä»¶å¼€å‘ç»éªŒã€‚\
                 è”ç³»æ–¹å¼ï¼šlisi@alibaba.comï¼Œç”µè¯ï¼š13900139000ã€‚\
                 å…¬å¸ç½‘ç«™ï¼šhttps://www.alibaba.com";

    println!("ğŸ“ è¾“å…¥æ–‡æœ¬:");
    println!("   {text2}");
    println!();

    let start = Instant::now();
    let entities2 = entity_extractor.extract_entities(text2).await?;
    let relations2 = relation_extractor
        .extract_relations(text2, &entities2)
        .await?;
    let duration = start.elapsed();

    println!("âœ… æå–ç»“æœï¼ˆè€—æ—¶: {duration:?}ï¼‰:");
    println!();
    println!("ğŸ“Š å®ä½“ç»Ÿè®¡:");

    // æŒ‰ç±»å‹ç»Ÿè®¡å®ä½“
    let mut entity_counts = std::collections::HashMap::new();
    for entity in &entities2 {
        *entity_counts
            .entry(entity.entity_type.as_str())
            .or_insert(0) += 1;
    }

    for (entity_type, count) in entity_counts.iter() {
        println!("   - {entity_type}: {count} ä¸ª");
    }
    println!();

    println!("ğŸ“‹ å®ä½“åˆ—è¡¨:");
    for entity in &entities2 {
        println!(
            "   - {} [{}] (ç½®ä¿¡åº¦: {:.2})",
            entity.name,
            entity.entity_type.as_str(),
            entity.confidence
        );
    }
    println!();

    println!("ğŸ”— å…³ç³»åˆ—è¡¨:");
    for relation in &relations2 {
        println!(
            "   - {} --[{}]--> {} (ç½®ä¿¡åº¦: {:.2})",
            relation.subject, relation.predicate, relation.object, relation.confidence
        );
    }
    println!();

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ç¤ºä¾‹ 4: çŸ¥è¯†å›¾è°±å¯è§†åŒ–ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("4ï¸âƒ£  çŸ¥è¯†å›¾è°±å¯è§†åŒ–");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("ğŸŒ çŸ¥è¯†å›¾è°±ç»“æ„:");
    println!();

    // æ„å»ºç®€å•çš„å›¾è°±è¡¨ç¤º
    for relation in &relations2 {
        println!("   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
        println!(
            "   â”‚ {} ({})",
            relation.subject,
            get_entity_type(&entities2, &relation.subject_id)
        );
        println!("   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        println!("                  â”‚");
        println!("                  â”‚ {}", relation.predicate);
        println!("                  â†“");
        println!("   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
        println!(
            "   â”‚ {} ({})",
            relation.object,
            get_entity_type(&entities2, &relation.object_id)
        );
        println!("   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
        println!();
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // ç¤ºä¾‹ 5: JSON å¯¼å‡º
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("5ï¸âƒ£  JSON å¯¼å‡º");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let json_output = serde_json::json!({
        "entities": entities2,
        "relations": relations2,
        "metadata": {
            "text_length": text2.len(),
            "entity_count": entities2.len(),
            "relation_count": relations2.len(),
        }
    });

    println!("ğŸ“„ JSON æ ¼å¼è¾“å‡º:");
    println!("{}", serde_json::to_string_pretty(&json_output)?);
    println!();

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // æ€»ç»“
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘          ğŸ‰ å®ä½“å’Œå…³ç³»æå–æ¼”ç¤ºå®Œæˆï¼                                  â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("âœ… æ¼”ç¤ºç»“æœ:");
    println!("   - å®ä½“æå–: æ”¯æŒ 10+ ç§å®ä½“ç±»å‹ âœ…");
    println!("   - å…³ç³»æå–: æ”¯æŒ 15+ ç§å…³ç³»ç±»å‹ âœ…");
    println!("   - ç½®ä¿¡åº¦è¯„åˆ†: æ¯ä¸ªæå–ç»“æœéƒ½æœ‰ç½®ä¿¡åº¦ âœ…");
    println!("   - æ€§èƒ½ä¼˜åŒ–: æ¯«ç§’çº§æå–é€Ÿåº¦ âœ…");
    println!();

    println!("ğŸ“ æ”¯æŒçš„å®ä½“ç±»å‹:");
    println!("   - Person (äººç‰©)");
    println!("   - Organization (ç»„ç»‡)");
    println!("   - Location (åœ°ç‚¹)");
    println!("   - Email (é‚®ç®±)");
    println!("   - Phone (ç”µè¯)");
    println!("   - Url (ç½‘å€)");
    println!("   - Date (æ—¥æœŸ)");
    println!("   - Money (é‡‘é¢)");
    println!("   - ç­‰ç­‰...");
    println!();

    println!("ğŸ”— æ”¯æŒçš„å…³ç³»ç±»å‹:");
    println!("   - WorksAt (å·¥ä½œäº)");
    println!("   - LocatedAt (ä½äº)");
    println!("   - Likes/Dislikes (å–œæ¬¢/ä¸å–œæ¬¢)");
    println!("   - Owns (æ‹¥æœ‰)");
    println!("   - FamilyOf (å®¶åº­å…³ç³»)");
    println!("   - FriendOf (æœ‹å‹å…³ç³»)");
    println!("   - ç­‰ç­‰...");
    println!();

    Ok(())
}

/// è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å®ä½“ ID è·å–å®ä½“ç±»å‹
fn get_entity_type<'a>(
    entities: &'a [agent_mem_core::extraction::Entity],
    entity_id: &str,
) -> &'a str {
    entities
        .iter()
        .find(|e| e.id == entity_id)
        .map(|e| e.entity_type.as_str())
        .unwrap_or("Unknown")
}
