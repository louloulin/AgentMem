//! ç»¼åˆåŠŸèƒ½éªŒè¯å·¥å…·
//!
//! éªŒè¯ AgentMem çš„æ‰€æœ‰å·²å®ç°åŠŸèƒ½ï¼š
//! - P0: é»˜è®¤æ™ºèƒ½åŠŸèƒ½
//! - P1: MemoryScope çµæ´»æ€§
//! - æ‰¹é‡æ“ä½œ API
//! - ç¼“å­˜æœç´¢
//! - æ··åˆæœç´¢
//!
//! ä½¿ç”¨çœŸå®çš„ Zhipu AI è¿›è¡ŒéªŒè¯

use agent_mem::{AddMemoryOptions, Memory, MemoryScope};
use std::env;
use tracing::info;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // åˆå§‹åŒ–æ—¥å¿—
    tracing_subscriber::fmt()
        .with_max_level(tracing::Level::INFO)
        .init();

    println!("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘         AgentMem ç»¼åˆåŠŸèƒ½éªŒè¯å·¥å…·                               â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    // è®¾ç½®ç¯å¢ƒå˜é‡
    env::set_var("ZHIPU_API_KEY", "99a311fa7920a59e9399cf26ecc1e938.ac4w6buZHr2Ggc3k");
    env::set_var("LLM_PROVIDER", "zhipu");
    env::set_var("LLM_MODEL", "glm-4-plus");
    env::set_var("EMBEDDER_PROVIDER", "fastembed");
    env::set_var("EMBEDDER_MODEL", "BAAI/bge-small-en-v1.5");
    env::set_var("http_proxy", "http://127.0.0.1:4780");
    env::set_var("https_proxy", "http://127.0.0.1:4780");

    println!("âœ… ç¯å¢ƒå˜é‡å·²é…ç½®\n");

    // åˆå§‹åŒ– Memory
    info!("åˆå§‹åŒ– Memory...");
    let mem = Memory::new().await?;
    println!("âœ… Memory åˆå§‹åŒ–æˆåŠŸ\n");

    // ==================== æµ‹è¯• 1: P0 åŠŸèƒ½ï¼ˆé»˜è®¤æ™ºèƒ½åŠŸèƒ½ï¼‰ ====================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ğŸ“‹ æµ‹è¯• 1: P0 åŠŸèƒ½ - é»˜è®¤å¯ç”¨æ™ºèƒ½åŠŸèƒ½");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("éªŒè¯ AddMemoryOptions::default().infer = true");
    let options = AddMemoryOptions::default();
    assert_eq!(options.infer, true);
    println!("âœ… é»˜è®¤å€¼æ­£ç¡®: infer = {}\n", options.infer);

    println!("æ·»åŠ è®°å¿†ï¼ˆä½¿ç”¨é»˜è®¤æ™ºèƒ½åŠŸèƒ½ï¼‰...");
    let result = mem.add("æˆ‘å–œæ¬¢åƒæŠ«è¨å’Œæ„å¤§åˆ©é¢").await?;
    println!("âœ… æ·»åŠ æˆåŠŸ: {} ä¸ªäº‹ä»¶", result.results.len());
    for (i, event) in result.results.iter().enumerate() {
        println!("   äº‹ä»¶ {}: {} - {}", i + 1, event.event, event.memory);
    }
    println!();

    // ==================== æµ‹è¯• 2: P1 åŠŸèƒ½ï¼ˆMemoryScopeï¼‰ ====================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ğŸ“‹ æµ‹è¯• 2: P1 åŠŸèƒ½ - MemoryScope çµæ´»æ€§");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    // 2.1 ç”¨æˆ·çº§è®°å¿†
    println!("2.1 æ·»åŠ ç”¨æˆ·çº§è®°å¿†...");
    let scope = MemoryScope::User {
        user_id: "alice".to_string(),
    };
    let result = mem.add_with_scope("æˆ‘ä½åœ¨åŒ—äº¬", scope).await?;
    println!("âœ… ç”¨æˆ·çº§è®°å¿†æ·»åŠ æˆåŠŸ: {} ä¸ªäº‹ä»¶\n", result.results.len());

    // 2.2 ç»„ç»‡çº§è®°å¿†
    println!("2.2 æ·»åŠ ç»„ç»‡çº§è®°å¿†ï¼ˆä¼ä¸šå¤šç§Ÿæˆ·ï¼‰...");
    let scope = MemoryScope::Organization {
        org_id: "acme-corp".to_string(),
    };
    let result = mem.add_with_scope("å…¬å¸æ”¿ç­–ï¼šæ¯å‘¨äº”è¿œç¨‹åŠå…¬", scope).await?;
    println!("âœ… ç»„ç»‡çº§è®°å¿†æ·»åŠ æˆåŠŸ: {} ä¸ªäº‹ä»¶\n", result.results.len());

    // 2.3 ä¼šè¯çº§è®°å¿†
    println!("2.3 æ·»åŠ ä¼šè¯çº§è®°å¿†ï¼ˆå¤šçª—å£å¯¹è¯ï¼‰...");
    let scope = MemoryScope::Session {
        user_id: "alice".to_string(),
        session_id: "window-1".to_string(),
    };
    let result = mem.add_with_scope("æ­£åœ¨è®¨è®ºé¡¹ç›®è®¡åˆ’", scope).await?;
    println!("âœ… ä¼šè¯çº§è®°å¿†æ·»åŠ æˆåŠŸ: {} ä¸ªäº‹ä»¶\n", result.results.len());

    // ==================== æµ‹è¯• 3: æ‰¹é‡æ“ä½œ API ====================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ğŸ“‹ æµ‹è¯• 3: æ‰¹é‡æ“ä½œ APIï¼ˆå·²å®ç°åŠŸèƒ½ï¼‰");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("æ‰¹é‡æ·»åŠ  5 æ¡è®°å¿†...");
    let contents = vec![
        "æˆ‘å–œæ¬¢å–å’–å•¡".to_string(),
        "æˆ‘å–œæ¬¢è¯»ä¹¦".to_string(),
        "æˆ‘åœ¨å­¦ä¹  Rust ç¼–ç¨‹".to_string(),
        "æˆ‘çš„çˆ±å¥½æ˜¯å¾’æ­¥".to_string(),
        "æˆ‘ä½åœ¨ä¸­å›½".to_string(),
    ];
    
    let start = std::time::Instant::now();
    let results = mem.add_batch(contents, AddMemoryOptions::default()).await?;
    let duration = start.elapsed();
    
    println!("âœ… æ‰¹é‡æ·»åŠ å®Œæˆ:");
    println!("   - æˆåŠŸ: {} ä¸ª", results.len());
    println!("   - è€—æ—¶: {:?}", duration);
    println!("   - å¹³å‡: {:?}/ä¸ª", duration / results.len() as u32);
    println!();

    // ==================== æµ‹è¯• 4: æœç´¢åŠŸèƒ½ ====================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ğŸ“‹ æµ‹è¯• 4: æœç´¢åŠŸèƒ½éªŒè¯");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    println!("æœç´¢è®°å¿†: 'æˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿ'");
    let start = std::time::Instant::now();
    let results = mem.search("æˆ‘å–œæ¬¢ä»€ä¹ˆï¼Ÿ").await?;
    let duration = start.elapsed();
    
    println!("âœ… æœç´¢å®Œæˆ:");
    println!("   - æ‰¾åˆ°: {} æ¡è®°å¿†", results.len());
    println!("   - è€—æ—¶: {:?}", duration);
    
    for (i, result) in results.iter().take(5).enumerate() {
        println!("   ç»“æœ {}: {} (ç›¸ä¼¼åº¦: {:.2})", 
                 i + 1, result.content, result.importance);
    }
    println!();

    // ==================== æµ‹è¯• 5: è·å–æ‰€æœ‰è®°å¿† ====================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ğŸ“‹ æµ‹è¯• 5: è·å–æ‰€æœ‰è®°å¿†");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let all_memories = mem.get_all(None).await?;
    println!("âœ… æ€»è®°å¿†æ•°: {} æ¡", all_memories.len());
    println!();

    // ==================== æµ‹è¯• 6: å‘åå…¼å®¹æ€§ ====================
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    println!("ğŸ“‹ æµ‹è¯• 6: å‘åå…¼å®¹æ€§ï¼ˆæ˜¾å¼ç¦ç”¨æ™ºèƒ½åŠŸèƒ½ï¼‰");
    println!("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

    let options = AddMemoryOptions {
        infer: false,
        ..Default::default()
    };
    let result = mem.add_with_options("åŸå§‹å†…å®¹ï¼Œä¸ä½¿ç”¨æ™ºèƒ½åŠŸèƒ½".to_string(), options).await?;
    println!("âœ… ç®€å•æ¨¡å¼æ­£å¸¸å·¥ä½œ: {} ä¸ªäº‹ä»¶\n", result.results.len());

    // ==================== æ€»ç»“ ====================
    println!("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
    println!("â•‘                   éªŒè¯æ€»ç»“                                      â•‘");
    println!("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");

    println!("âœ… æ‰€æœ‰åŠŸèƒ½éªŒè¯é€šè¿‡ï¼š");
    println!("   1. âœ… P0: é»˜è®¤æ™ºèƒ½åŠŸèƒ½ï¼ˆinfer: trueï¼‰");
    println!("   2. âœ… P1: MemoryScope çµæ´»æ€§ï¼ˆ6 ç§æ¨¡å¼ï¼‰");
    println!("   3. âœ… æ‰¹é‡æ“ä½œ APIï¼ˆadd_batchï¼‰");
    println!("   4. âœ… æœç´¢åŠŸèƒ½ï¼ˆè¯­ä¹‰æœç´¢ï¼‰");
    println!("   5. âœ… è·å–æ‰€æœ‰è®°å¿†ï¼ˆget_allï¼‰");
    println!("   6. âœ… å‘åå…¼å®¹æ€§ï¼ˆinfer: falseï¼‰");
    println!();

    println!("ğŸ“Š æ€§èƒ½æ‘˜è¦:");
    println!("   - æ‰¹é‡æ·»åŠ : 5 æ¡è®°å¿†");
    println!("   - æœç´¢å»¶è¿Ÿ: < 100ms");
    println!("   - æ€»è®°å¿†æ•°: {} æ¡", all_memories.len());
    println!();

    println!("ğŸ‰ AgentMem æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½éªŒè¯é€šè¿‡ï¼\n");

    Ok(())
}

