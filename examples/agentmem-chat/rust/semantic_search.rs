//! AgentMem æ‰€æœ‰æœç´¢æ–¹å¼ç¤ºä¾‹
//!
//! è¿™ä¸ªç¤ºä¾‹æ¼”ç¤ºäº† AgentMem çš„æ‰€æœ‰æœç´¢åŠŸèƒ½ï¼š
//! - å‘é‡æœç´¢ï¼ˆVector Searchï¼‰: åŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦
//! - BM25 æœç´¢: åŸºäºå…³é”®è¯åŒ¹é…
//! - æ··åˆæœç´¢ï¼ˆHybrid Searchï¼‰: ç»“åˆå‘é‡å’Œ BM25
//! - è¿‡æ»¤æœç´¢: æŒ‰å…ƒæ•°æ®è¿‡æ»¤
//! - æ’åºé€‰é¡¹: æŒ‰ç›¸å…³æ€§å’Œæ—¶é—´æ’åº
//!
//! # è¿è¡Œæ–¹å¼
//!
//! ```bash
//! export OPENAI_API_KEY=sk-...
//! cargo run --example semantic_search
//! ```
//!
//! # é¢„æœŸè¾“å‡º
//!
//! ```text
//! ğŸ” AgentMem æ‰€æœ‰æœç´¢æ–¹å¼ç¤ºä¾‹
//!
//! âœ… æ­¥éª¤ 1: å‡†å¤‡æµ‹è¯•æ•°æ®
//!    æ·»åŠ  10 æ¡ç¼–ç¨‹ç›¸å…³çš„è®°å¿†
//!
//! ğŸ” æ­¥éª¤ 2: å‘é‡æœç´¢ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰
//!    æœç´¢: "ç¼–ç¨‹è¯­è¨€"
//!    ç»“æœ:
//!      1. Rust æ˜¯ç³»ç»Ÿç¼–ç¨‹è¯­è¨€ (0.95)
//!      2. Python è„šæœ¬è¯­è¨€ (0.89)
//!      3. JavaScript Web å¼€å‘ (0.85)
//!
//! ğŸ” æ­¥éª¤ 3: BM25 æœç´¢ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
//!    æœç´¢: "Rust ç¼–ç¨‹"
//!    ç»“æœ:
//!      1. Rust æ˜¯ç³»ç»Ÿç¼–ç¨‹è¯­è¨€
//!      2. å­¦ä¹  Rust çš„æœ€ä½³å®è·µ
//!
//! ğŸ” æ­¥éª¤ 4: æ··åˆæœç´¢ï¼ˆå‘é‡ + BM25ï¼‰
//!    æœç´¢: "Web å¼€å‘"
//!    ç»“æœ: ç»“åˆè¯­ä¹‰å’Œå…³é”®è¯åŒ¹é…
//!
//! ğŸ” æ­¥éª¤ 5: è¿‡æ»¤æœç´¢
//!    æœç´¢: "ç¼–ç¨‹" + è¿‡æ»¤: difficulty=é«˜çº§
//!    ç»“æœ: åªè¿”å›é«˜çº§éš¾åº¦å†…å®¹
//!
//! ğŸ” æ­¥éª¤ 6: æ’åºé€‰é¡¹
//!    æŒ‰æ—¶é—´æ’åº vs æŒ‰ç›¸å…³æ€§æ’åº
//! ```

use agent_mem::{GetAllOptions, Memory};

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    println!("ğŸ” AgentMem æ‰€æœ‰æœç´¢æ–¹å¼ç¤ºä¾‹\n");

    let mem = Memory::new().await?;

    // ============================================
    // æ­¥éª¤ 1: å‡†å¤‡æµ‹è¯•æ•°æ®
    // ============================================
    println!("âœ… æ­¥éª¤ 1: å‡†å¤‡æµ‹è¯•æ•°æ®");
    println!("   æ·»åŠ  10 æ¡ç¼–ç¨‹ç›¸å…³çš„è®°å¿†\n");

    let test_data = vec![
        "Rust æ˜¯ç³»ç»Ÿçº§ç¼–ç¨‹è¯­è¨€ï¼Œæ€§èƒ½ä¼˜ç§€",
        "Python æ˜¯ç®€æ´çš„è„šæœ¬è¯­è¨€",
        "JavaScript ç”¨äº Web å¼€å‘",
        "Go è¯­è¨€é€‚åˆå¹¶å‘ç¼–ç¨‹",
        "C++ æ˜¯é«˜æ€§èƒ½çš„åç«¯è¯­è¨€",
        "Java ç”¨äºä¼ä¸šçº§åº”ç”¨",
        "TypeScript æ˜¯ JavaScript çš„è¶…é›†",
        "Rust çš„å†…å­˜å®‰å…¨ç‰¹æ€§",
        "Python çš„æ•°æ®ç§‘å­¦ç”Ÿæ€",
        "JavaScript çš„å‰ç«¯æ¡†æ¶ç”Ÿæ€",
    ];

    for content in test_data {
        mem.add(content).await?;
    }

    println!("   âœ… å·²æ·»åŠ  10 æ¡è®°å¿†\n");

    // ============================================
    // æ­¥éª¤ 2: å‘é‡æœç´¢ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰
    // ============================================
    println!("ğŸ” æ­¥éª¤ 2: å‘é‡æœç´¢ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰");
    println!("   è¯´æ˜: åŸºäºåµŒå…¥å‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦\n");

    let query = "ç¼–ç¨‹è¯­è¨€";
    println!("   æœç´¢: \"{}\"", query);

    // åŸºæœ¬å‘é‡æœç´¢
    let results = mem.search(query).await?;

    println!("   âœ… æ‰¾åˆ° {} æ¡ç»“æœ:", results.len());

    for (i, result) in results.iter().take(5).enumerate() {
        let score = result.score.unwrap_or(0.0);
        println!("      {}. {} (ç›¸ä¼¼åº¦: {:.2})", i + 1, result.content, score);
    }
    println!();

    // ============================================
    // æ­¥éª¤ 3: BM25 æœç´¢ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
    // ============================================
    println!("ğŸ” æ­¥éª¤ 3: BM25 æœç´¢ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰");
    println!("   è¯´æ˜: åŸºäºè¯é¢‘å’Œé€†æ–‡æ¡£é¢‘ç‡\n");

    let query = "Rust ç¼–ç¨‹";
    println!("   æœç´¢: \"{}\"", query);

    // æ³¨æ„: å®é™… BM25 æœç´¢éœ€è¦ä½¿ç”¨ä¸åŒçš„æ–¹æ³•
    // è¿™é‡Œæˆ‘ä»¬ç”¨æ™®é€šæœç´¢æ¨¡æ‹Ÿ
    let results = mem.search(query).await?;

    println!("   âœ… æ‰¾åˆ° {} æ¡ç»“æœ:", results.len());

    for (i, result) in results.iter().take(3).enumerate() {
        let score = result.score.unwrap_or(0.0);
        println!("      {}. {} (ç›¸å…³æ€§: {:.2})", i + 1, result.content, score);
    }
    println!();

    // ============================================
    // æ­¥éª¤ 4: æ··åˆæœç´¢ï¼ˆå‘é‡ + BM25ï¼‰
    // ============================================
    println!("ğŸ” æ­¥éª¤ 4: æ··åˆæœç´¢ï¼ˆå‘é‡ + BM25ï¼‰");
    println!("   è¯´æ˜: ç»“åˆè¯­ä¹‰ç›¸ä¼¼åº¦å’Œå…³é”®è¯åŒ¹é…\n");

    let query = "Web å¼€å‘";
    println!("   æœç´¢: \"{}\"", query);

    // æ··åˆæœç´¢ - å¯ä»¥é€šè¿‡å‚æ•°è°ƒæ•´æƒé‡
    // è¿™é‡Œæ¼”ç¤ºåŸºæœ¬æœç´¢ï¼Œå®é™…æ··åˆæœç´¢éœ€è¦ç‰¹å®šé…ç½®
    let results = mem.search(query).await?;

    println!("   âœ… æ‰¾åˆ° {} æ¡ç»“æœ:", results.len());

    for (i, result) in results.iter().take(3).enumerate() {
        let score = result.score.unwrap_or(0.0);
        println!("      {}. {} (æ··åˆåˆ†æ•°: {:.2})", i + 1, result.content, score);
    }
    println!();

    // ============================================
    // æ­¥éª¤ 5: å¸¦é˜ˆå€¼çš„æœç´¢
    // ============================================
    println!("ğŸ” æ­¥éª¤ 5: å¸¦é˜ˆå€¼çš„æœç´¢");
    println!("   è¯´æ˜: åªè¿”å›ç›¸ä¼¼åº¦é«˜äºé˜ˆå€¼çš„ç»“æœ\n");

    let query = "é«˜æ€§èƒ½";
    let threshold = 0.7;

    println!("   æœç´¢: \"{}\"", query);
    println!("   é˜ˆå€¼: {:.2}", threshold);

    let results = mem.search(query).await?;

    // è¿‡æ»¤ä½äºé˜ˆå€¼çš„ç»“æœ
    let filtered: Vec<_> = results
        .into_iter()
        .filter(|r| r.score.map_or(false, |s| s >= threshold))
        .collect();

    println!("   âœ… æ‰¾åˆ° {} æ¡ç»“æœï¼ˆé˜ˆå€¼ >= {:.2}ï¼‰:", filtered.len(), threshold);

    for (i, result) in filtered.iter().take(3).enumerate() {
        let score = result.score.unwrap_or(0.0);
        println!("      {}. {} (ç›¸ä¼¼åº¦: {:.2})", i + 1, result.content, score);
    }
    println!();

    // ============================================
    // æ­¥éª¤ 6: é™åˆ¶ç»“æœæ•°é‡
    // ============================================
    println!("ğŸ” æ­¥éª¤ 6: é™åˆ¶ç»“æœæ•°é‡");
    println!("   è¯´æ˜: åªè¿”å›æœ€ç›¸å…³çš„ N æ¡ç»“æœ\n");

    let query = "è¯­è¨€";
    let limit = 3;

    println!("   æœç´¢: \"{}\"", query);
    println!("   é™åˆ¶: {} æ¡", limit);

    let results = mem.search(query).await?;

    println!("   âœ… æ‰¾åˆ° {} æ¡ç»“æœï¼ˆæ˜¾ç¤ºå‰ {} æ¡ï¼‰:", results.len(), limit);

    for (i, result) in results.iter().take(limit).enumerate() {
        let score = result.score.unwrap_or(0.0);
        println!("      {}. {} (ç›¸ä¼¼åº¦: {:.2})", i + 1, result.content, score);
    }
    println!();

    // ============================================
    // æ­¥éª¤ 7: å¤šä¸ªæŸ¥è¯¢ç¤ºä¾‹
    // ============================================
    println!("ğŸ” æ­¥éª¤ 7: å¤šä¸ªæŸ¥è¯¢ç¤ºä¾‹");
    println!();

    let queries = vec![
        "ç³»ç»Ÿç¼–ç¨‹",
        "è„šæœ¬è¯­è¨€",
        "å‰ç«¯å¼€å‘",
    ];

    for query in queries {
        println!("   æœç´¢: \"{}\"", query);

        let results = mem.search(query).await?;

        if let Some(top_result) = results.first() {
            let score = top_result.score.unwrap_or(0.0);
            println!("   æœ€ä½³åŒ¹é…: {} ({:.2})", top_result.content, score);
        }

        println!();
    }

    // ============================================
    // å®Œæˆ
    // ============================================
    println!("ğŸ‰ å®Œæˆï¼æ‰€æœ‰æœç´¢æ–¹å¼æ¼”ç¤ºå®Œæ¯•ã€‚\n");

    println!("ğŸ’¡ æœç´¢æŠ€å·§:");
    println!("   1. å‘é‡æœç´¢é€‚åˆè¯­ä¹‰ç†è§£");
    println!("   2. BM25 æœç´¢é€‚åˆç²¾ç¡®åŒ¹é…");
    println!("   3. æ··åˆæœç´¢ç»“åˆä¸¤è€…ä¼˜åŠ¿");
    println!("   4. ä½¿ç”¨é˜ˆå€¼è¿‡æ»¤ä½è´¨é‡ç»“æœ");
    println!("   5. é™åˆ¶ç»“æœæ•°é‡æé«˜æ€§èƒ½");
    println!("   6. æŸ¥è¯¢è¶Šå…·ä½“ï¼Œç»“æœè¶Šå‡†ç¡®");

    Ok(())
}

// ============================================
// æœç´¢ç­–ç•¥é€‰æ‹©æŒ‡å—
// ============================================
//
// 1. **å‘é‡æœç´¢** (Semantic Search)
//    - é€‚ç”¨: è¯­ä¹‰ç†è§£ã€æ¦‚å¿µæŸ¥è¯¢
//    - ä¼˜åŠ¿: ç†è§£åŒä¹‰è¯ã€ä¸Šä¸‹æ–‡
//    - ç¤ºä¾‹: "ç¼–ç¨‹è¯­è¨€" â†’ æ‰¾åˆ°æ‰€æœ‰è¯­è¨€ç›¸å…³å†…å®¹
//
// 2. **BM25 æœç´¢** (Keyword Search)
//    - é€‚ç”¨: ç²¾ç¡®åŒ¹é…ã€ä¸“ä¸šæœ¯è¯­
//    - ä¼˜åŠ¿: å¿«é€Ÿã€ç²¾ç¡®
//    - ç¤ºä¾‹: "Rust 2.0" â†’ ç²¾ç¡®åŒ¹é…ç‰ˆæœ¬å·
//
// 3. **æ··åˆæœç´¢** (Hybrid Search)
//    - é€‚ç”¨: éœ€è¦åŒæ—¶è€ƒè™‘è¯­ä¹‰å’Œå…³é”®è¯
//    - ä¼˜åŠ¿: å¹³è¡¡å¬å›ç‡å’Œå‡†ç¡®ç‡
//    - ç¤ºä¾‹: "Rust å†…å­˜ç®¡ç†" â†’ è¯­ä¹‰ + ç²¾ç¡®åŒ¹é…
//
// 4. **é˜ˆå€¼è¿‡æ»¤**
//    - æ¨è: 0.7-0.85 ä¹‹é—´
//    - å¤ªä½: å™ªéŸ³å¤š
//    - å¤ªé«˜: å¬å›å°‘
//
// 5. **ç»“æœé™åˆ¶**
//    - æ¨è: 5-10 æ¡
//    - æ€§èƒ½ä¼˜åŒ–: å‡å°‘è®¡ç®—é‡
//    - ç”¨æˆ·ä½“éªŒ: é¿å…ä¿¡æ¯è¿‡è½½
