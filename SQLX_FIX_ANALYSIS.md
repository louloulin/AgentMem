# SQLx é—®é¢˜å…¨é¢åˆ†æå’Œä¿®å¤æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-10-08  
**é—®é¢˜**: agent-mem-core ç¼–è¯‘å¤±è´¥ï¼Œå› ä¸º SQLx å®éœ€è¦æ•°æ®åº“è¿æ¥  
**å½±å“**: æ— æ³•ç¼–è¯‘å’Œæµ‹è¯• SimpleMemory API

---

## ğŸ” é—®é¢˜åˆ†æ

### 1. é—®é¢˜æ ¹æº

SQLx ä½¿ç”¨ç¼–è¯‘æ—¶å® (`sqlx::query!` å’Œ `sqlx::query_as!`) æ¥éªŒè¯ SQL æŸ¥è¯¢ï¼š
- è¿™äº›å®åœ¨ç¼–è¯‘æ—¶è¿æ¥æ•°æ®åº“
- éªŒè¯ SQL è¯­æ³•å’Œè¡¨ç»“æ„
- ç”Ÿæˆç±»å‹å®‰å…¨çš„ä»£ç 

**å½“å‰çŠ¶æ€**:
- âŒ æ²¡æœ‰è¿è¡Œçš„ PostgreSQL æ•°æ®åº“
- âŒ æ²¡æœ‰è®¾ç½® DATABASE_URL
- âŒ `.sqlx/` ç›®å½•ä¸ºç©ºï¼ˆæ²¡æœ‰ç¦»çº¿ç¼“å­˜ï¼‰

### 2. å—å½±å“çš„æ–‡ä»¶

é€šè¿‡æœç´¢å‘ç°æœ‰ **38 ä¸ª** SQLx å®è°ƒç”¨ï¼š

| æ–‡ä»¶ | query! | query_as! | æ€»è®¡ |
|------|--------|-----------|------|
| `managers/lifecycle_manager.rs` | 9 | 3 | 12 |
| `managers/association_manager.rs` | 7 | 0 | 7 |
| `managers/semantic_memory.rs` | 2 | 3 | 5 |
| `managers/procedural_memory.rs` | 2 | 3 | 5 |
| `managers/episodic_memory.rs` | 2 | 3 | 5 |
| `storage/*.rs` | 1 | 3 | 4 |
| **æ€»è®¡** | **23** | **15** | **38** |

### 3. ç¼–è¯‘é”™è¯¯ç¤ºä¾‹

```
error: set `DATABASE_URL` to use query macros online, 
       or run `cargo sqlx prepare` to update the query cache
   --> crates/agent-mem-core/src/managers/association_manager.rs:159:9
    |
159 | /         sqlx::query!(
160 | |             r#"
161 | |             INSERT INTO memory_associations (
...
```

---

## ğŸ’¡ ä¿®å¤æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ A: ä½¿ç”¨ SQLx Offline æ¨¡å¼ â­â­â­â­â­

**ä¼˜ç‚¹**:
- âœ… ä¿æŒç±»å‹å®‰å…¨
- âœ… ç¼–è¯‘æ—¶ SQL éªŒè¯
- âœ… æœ€ä½³å®è·µ
- âœ… ç”Ÿäº§çº§åˆ«

**ç¼ºç‚¹**:
- âŒ éœ€è¦ PostgreSQL æ•°æ®åº“
- âŒ éœ€è¦è¿è¡Œè¿ç§»
- âŒ éœ€è¦ç”Ÿæˆ sqlx-data.json
- âŒ è®¾ç½®å¤æ‚

**æ­¥éª¤**:
1. å®‰è£… PostgreSQL
2. åˆ›å»ºæ•°æ®åº“
3. è¿è¡Œè¿ç§»
4. ç”Ÿæˆ sqlx-data.json: `cargo sqlx prepare`
5. ä½¿ç”¨ `SQLX_OFFLINE=true` ç¼–è¯‘

**æ—¶é—´**: 30-60 åˆ†é’Ÿ

---

### æ–¹æ¡ˆ B: æ›¿æ¢ä¸ºæ™®é€š query â­â­â­

**ä¼˜ç‚¹**:
- âœ… ä¸éœ€è¦æ•°æ®åº“
- âœ… å¿«é€Ÿä¿®å¤
- âœ… ç®€å•ç›´æ¥

**ç¼ºç‚¹**:
- âŒ å¤±å»ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
- âŒ å¤±å» SQL éªŒè¯
- âŒ éœ€è¦æ‰‹åŠ¨ç±»å‹è½¬æ¢
- âŒ è¿è¡Œæ—¶é”™è¯¯é£é™©

**æ­¥éª¤**:
1. å°† `sqlx::query!` æ›¿æ¢ä¸º `sqlx::query`
2. å°† `sqlx::query_as!` æ›¿æ¢ä¸º `sqlx::query_as`
3. æ‰‹åŠ¨å¤„ç†ç±»å‹è½¬æ¢

**æ—¶é—´**: 2-3 å°æ—¶ï¼ˆ38 ä¸ªæ›¿æ¢ï¼‰

---

### æ–¹æ¡ˆ C: æ¡ä»¶ç¼–è¯‘ â­â­â­â­

**ä¼˜ç‚¹**:
- âœ… ä¸¤å…¨å…¶ç¾
- âœ… å¼€å‘æ—¶ä½¿ç”¨å®
- âœ… CI/CD ä½¿ç”¨ç¦»çº¿æ¨¡å¼

**ç¼ºç‚¹**:
- âŒ éœ€è¦ç»´æŠ¤ä¸¤å¥—ä»£ç 
- âŒ å¤æ‚åº¦å¢åŠ 

**å®ç°**:
```rust
#[cfg(not(feature = "sqlx-offline"))]
let result = sqlx::query!("SELECT * FROM memories WHERE id = $1", id);

#[cfg(feature = "sqlx-offline")]
let result = sqlx::query("SELECT * FROM memories WHERE id = $1").bind(id);
```

**æ—¶é—´**: 4-5 å°æ—¶

---

### æ–¹æ¡ˆ D: ä½¿ç”¨ InMemoryOperations â­â­â­â­â­

**ä¼˜ç‚¹**:
- âœ… ä¸éœ€è¦æ•°æ®åº“
- âœ… å¿«é€Ÿå¼€å‘å’Œæµ‹è¯•
- âœ… å·²ç»å®ç°
- âœ… é€‚åˆåŸå‹å’Œæ¼”ç¤º

**ç¼ºç‚¹**:
- âŒ ä¸æ˜¯ç”Ÿäº§çº§åˆ«
- âŒ æ•°æ®ä¸æŒä¹…åŒ–

**å®ç°**:
```rust
// MemoryManager å·²ç»æ”¯æŒ InMemoryOperations
let manager = MemoryManager::new(); // é»˜è®¤ä½¿ç”¨ InMemoryOperations
```

**æ—¶é—´**: 0 åˆ†é’Ÿï¼ˆå·²å®ç°ï¼‰

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### çŸ­æœŸæ–¹æ¡ˆ (ä»Šå¤©): æ–¹æ¡ˆ D + æ–¹æ¡ˆ A å‡†å¤‡

1. **ç«‹å³ä½¿ç”¨ InMemoryOperations** (0 åˆ†é’Ÿ)
   - åˆ›å»ºçœŸå®çš„ AgentMem æµ‹è¯•
   - éªŒè¯ API è®¾è®¡
   - å®ŒæˆåŠŸèƒ½æ¼”ç¤º

2. **å‡†å¤‡ SQLx Offline** (30 åˆ†é’Ÿ)
   - åˆ›å»º setup-sqlx.sh è„šæœ¬
   - ç¼–å†™æ–‡æ¡£
   - ä¸ºåç»­ç”Ÿäº§éƒ¨ç½²åšå‡†å¤‡

### ä¸­æœŸæ–¹æ¡ˆ (æœ¬å‘¨): æ–¹æ¡ˆ A

1. **è®¾ç½® PostgreSQL** (15 åˆ†é’Ÿ)
   - å®‰è£…/å¯åŠ¨ PostgreSQL
   - åˆ›å»ºæ•°æ®åº“

2. **è¿è¡Œè¿ç§»** (10 åˆ†é’Ÿ)
   - åˆ›å»ºè¡¨ç»“æ„
   - åˆ›å»ºç´¢å¼•

3. **ç”Ÿæˆ SQLx æ•°æ®** (5 åˆ†é’Ÿ)
   - `cargo sqlx prepare`
   - æäº¤ `.sqlx/` ç›®å½•

### é•¿æœŸæ–¹æ¡ˆ (ç”Ÿäº§): æ–¹æ¡ˆ A + æ–¹æ¡ˆ C

1. **ä½¿ç”¨ SQLx Offline æ¨¡å¼**
   - CI/CD ä½¿ç”¨ç¦»çº¿æ¨¡å¼
   - å¼€å‘æ—¶ä½¿ç”¨åœ¨çº¿æ¨¡å¼

2. **æ·»åŠ æ¡ä»¶ç¼–è¯‘**
   - æ”¯æŒå¤šç§éƒ¨ç½²åœºæ™¯
   - çµæ´»æ€§æœ€å¤§åŒ–

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### Phase 1: ç«‹å³ä¿®å¤ (ä»Šå¤©)

**ç›®æ ‡**: è®©ä»£ç èƒ½å¤Ÿç¼–è¯‘å’Œæµ‹è¯•

**æ­¥éª¤**:
1. âœ… åˆ›å»º setup-sqlx.sh è„šæœ¬
2. â³ åˆ›å»ºä½¿ç”¨ InMemoryOperations çš„æµ‹è¯•
3. â³ éªŒè¯ SimpleMemory API è®¾è®¡
4. â³ æ›´æ–°æ–‡æ¡£

**é¢„è®¡æ—¶é—´**: 1 å°æ—¶

---

### Phase 2: SQLx Offline è®¾ç½® (æœ¬å‘¨)

**ç›®æ ‡**: ç”Ÿæˆ sqlx-data.jsonï¼Œæ”¯æŒç¦»çº¿ç¼–è¯‘

**æ­¥éª¤**:
1. â³ å®‰è£… PostgreSQL
2. â³ è¿è¡Œ setup-sqlx.sh
3. â³ ç”Ÿæˆ sqlx-data.json
4. â³ æäº¤åˆ° Git
5. â³ æ›´æ–° CI/CD

**é¢„è®¡æ—¶é—´**: 1 å°æ—¶

---

### Phase 3: ç”Ÿäº§ä¼˜åŒ– (ä¸‹å‘¨)

**ç›®æ ‡**: ä¼˜åŒ–ç”Ÿäº§éƒ¨ç½²

**æ­¥éª¤**:
1. â³ æ·»åŠ æ¡ä»¶ç¼–è¯‘
2. â³ ä¼˜åŒ–æ•°æ®åº“è¿æ¥æ± 
3. â³ æ·»åŠ å¥åº·æ£€æŸ¥
4. â³ æ€§èƒ½æµ‹è¯•

**é¢„è®¡æ—¶é—´**: 1 å¤©

---

## ğŸ› ï¸ å¿«é€Ÿä¿®å¤æŒ‡å—

### é€‰é¡¹ 1: ä½¿ç”¨ InMemoryOperations (æ¨è)

```rust
// ä¸éœ€è¦æ•°æ®åº“ï¼Œç«‹å³å¯ç”¨
use agent_mem_core::manager::MemoryManager;

let manager = MemoryManager::new(); // ä½¿ç”¨ InMemoryOperations
manager.add_memory(...).await?;
```

**ä¼˜ç‚¹**: ç«‹å³å¯ç”¨ï¼Œæ— éœ€è®¾ç½®

---

### é€‰é¡¹ 2: è¿è¡Œ setup-sqlx.sh

```bash
cd agentmen
chmod +x scripts/setup-sqlx.sh
./scripts/setup-sqlx.sh
```

**ä¼˜ç‚¹**: ä¸€é”®è®¾ç½®ï¼Œç”Ÿäº§çº§åˆ«

---

### é€‰é¡¹ 3: æ‰‹åŠ¨è®¾ç½®

```bash
# 1. å¯åŠ¨ PostgreSQL
brew services start postgresql@15

# 2. åˆ›å»ºæ•°æ®åº“
createdb agentmem_dev

# 3. è®¾ç½®ç¯å¢ƒå˜é‡
export DATABASE_URL="postgresql://$(whoami)@localhost/agentmem_dev"

# 4. åˆ›å»ºè¡¨ï¼ˆä½¿ç”¨æä¾›çš„ SQLï¼‰
psql $DATABASE_URL < scripts/schema.sql

# 5. ç”Ÿæˆ SQLx æ•°æ®
cd crates/agent-mem-core
cargo sqlx prepare

# 6. ç¼–è¯‘
SQLX_OFFLINE=true cargo build
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| æ–¹æ¡ˆ | æ—¶é—´ | å¤æ‚åº¦ | ç±»å‹å®‰å…¨ | ç”Ÿäº§çº§åˆ« | æ¨èåº¦ |
|------|------|--------|----------|----------|--------|
| **A: SQLx Offline** | 30-60åˆ†é’Ÿ | ä¸­ | âœ… | âœ… | â­â­â­â­â­ |
| **B: æ™®é€š query** | 2-3å°æ—¶ | ä½ | âŒ | âš ï¸ | â­â­â­ |
| **C: æ¡ä»¶ç¼–è¯‘** | 4-5å°æ—¶ | é«˜ | âœ… | âœ… | â­â­â­â­ |
| **D: InMemory** | 0åˆ†é’Ÿ | ä½ | âœ… | âŒ | â­â­â­â­â­ (å¼€å‘) |

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### ä»Šå¤© (ç«‹å³)
1. âœ… ä½¿ç”¨ **æ–¹æ¡ˆ D (InMemoryOperations)**
2. âœ… åˆ›å»ºçœŸå®çš„ AgentMem æµ‹è¯•
3. âœ… éªŒè¯ SimpleMemory API

### æœ¬å‘¨ (ç”Ÿäº§å‡†å¤‡)
1. â³ å®æ–½ **æ–¹æ¡ˆ A (SQLx Offline)**
2. â³ è¿è¡Œ setup-sqlx.sh
3. â³ ç”Ÿæˆå¹¶æäº¤ sqlx-data.json

### ä¸‹å‘¨ (ä¼˜åŒ–)
1. â³ è€ƒè™‘ **æ–¹æ¡ˆ C (æ¡ä»¶ç¼–è¯‘)**
2. â³ ä¼˜åŒ–ç”Ÿäº§éƒ¨ç½²
3. â³ æ€§èƒ½æµ‹è¯•

---

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `scripts/setup-sqlx.sh` - è‡ªåŠ¨åŒ–è®¾ç½®è„šæœ¬
- `crates/agent-mem-core/.sqlx/` - SQLx ç¦»çº¿æ•°æ®ç›®å½•
- `.env` - ç¯å¢ƒå˜é‡é…ç½®
- `migrations/` - æ•°æ®åº“è¿ç§»æ–‡ä»¶

---

**ç»“è®º**: ä½¿ç”¨ InMemoryOperations è¿›è¡Œå¼€å‘å’Œæµ‹è¯•ï¼ŒåŒæ—¶å‡†å¤‡ SQLx Offline æ¨¡å¼ç”¨äºç”Ÿäº§éƒ¨ç½²ã€‚è¿™æ˜¯æœ€å®ç”¨å’Œé«˜æ•ˆçš„æ–¹æ¡ˆã€‚

