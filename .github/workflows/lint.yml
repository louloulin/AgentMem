name: Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  rustfmt:
    name: Check formatting
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Display formatting diff if needed
        if: failure()
        run: cargo fmt --all -- --check --verbose

  clippy:
    name: Run Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libssl-dev pkg-config

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run Clippy (workspace)
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Display Clippy warnings
        if: failure()
        run: |
          echo "### Clippy Warnings :warning:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cargo clippy --all-targets --all-features --message-format=short 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  typos:
    name: Check for typos
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check for typos
        uses: crate-ci/typos@master
        with:
          config: .config/typos.toml

  license-check:
    name: Check license headers
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check license headers
        uses: apache/skywalking-eyes/header@v0.4.0
        with:
          config: .licenserc.yaml
          mode: validate

  unused-dependencies:
    name: Check unused dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-udeps
        run: cargo install cargo-udeps --locked

      - name: Check unused dependencies
        run: cargo +stable udeps --all-targets

  documentation-coverage:
    name: Check documentation coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Check documentation coverage
        run: |
          cargo doc --no-deps --all-features 2>&1 | tee doc-output.txt

      - name: Display undocumented items
        if: failure()
        run: |
          echo "### Undocumented Items :memo:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -E "warning:|error:" doc-output.txt || echo "No warnings found" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  json-schema:
    name: Validate JSON schemas
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate JSON schemas
        run: |
          # Validate configuration files
          for file in $(find . -name "*.json" -not -path "*/node_modules/*" -not -path "*/target/*"); do
            echo "Validating $file"
            jq empty "$file" || exit 1
          done

  markdown-links:
    name: Check markdown links
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: yes
          use-verbose-mode: yes
          config-file: .config/markdown-link-check.json
          check-modified-files-only: 'no'
          base-branch: main

  summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [rustfmt, clippy, typos, license-check]
    if: always()

    steps:
      - name: Display summary
        run: |
          echo "## Lint Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rustfmt | ${{ needs.rustfmt.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Clippy | ${{ needs.clippy.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Typos | ${{ needs.typos.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
