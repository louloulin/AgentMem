# 商品记忆脚本分析报告

## 脚本概述

**脚本名称**: `add_product_memories.sh`  
**功能**: 批量写入商品记忆数据  
**日期**: 2025-11-07

## 脚本结构分析

### 1. 配置参数

```bash
API_BASE="${API_BASE:-http://localhost:8080}"  # API基础地址
TOTAL_PRODUCTS=1000                             # 总商品数
BATCH_SIZE=100                                  # 批次大小
TOTAL_BATCHES=$((TOTAL_PRODUCTS / BATCH_SIZE))  # 总批次数 = 10
```

**分析**:
- ✅ 使用环境变量支持自定义API地址
- ✅ 分批处理，避免一次性请求过多
- ✅ 批次大小合理（100条/批次）

### 2. 数据定义

#### 2.1 商品分类 (50个分类)
```bash
declare -a CATEGORIES=(
    "电子产品:手机" "电子产品:电脑" ...
    "服装鞋帽:男装" "服装鞋帽:女装" ...
    ...
)
```

**结构**: `主分类:子分类`  
**覆盖**: 10个主分类，每个主分类5个子分类

#### 2.2 品牌列表 (40个品牌)
```bash
declare -a BRANDS=(
    "Apple" "Samsung" "Huawei" ...  # 电子产品
    "Nike" "Adidas" "Puma" ...      # 服装
    "Coca-Cola" "Pepsi" ...         # 食品
    ...
)
```

**覆盖**: 多个行业的主流品牌

#### 2.3 价格区间 (10个区间)
```bash
declare -a PRICE_RANGES=(
    "10-50" "50-100" ... "20000-50000"
)
```

**范围**: ¥10 - ¥50,000

### 3. 核心函数

#### 3.1 `generate_product_name()`
**功能**: 根据分类和品牌生成商品名称  
**规则**:
- 电子产品: `{品牌} {子分类} 旗舰版 P{ID}`
- 服装鞋帽: `{品牌} {子分类} 时尚款 S{ID}`
- 食品饮料: `{品牌} {子分类} 精选装 F{ID}`
- ...

**示例**: `Apple 手机 旗舰版 P1`

#### 3.2 `generate_price()`
**功能**: 在指定价格区间内生成随机价格  
**实现**: `RANDOM % (max - min + 1) + min`

#### 3.3 `generate_stock()`
**功能**: 生成随机库存数量  
**范围**: 50-1049件

#### 3.4 `add_product_memory()`
**功能**: 添加单个商品记忆

**请求格式**:
```json
{
  "content": "商品ID: P000001, 名称: Apple 手机 旗舰版 P1, 分类: 电子产品>手机, 品牌: Apple, 价格: ¥5000, 库存: 200件, 状态: 在售",
  "memory_type": "Semantic",
  "importance": 0.8,
  "metadata": {
    "product_id": "P000001",
    "category": "电子产品",
    "subcategory": "手机",
    "brand": "Apple",
    "price": "5000",
    "stock": "200",
    "status": "active",
    "scope_type": "global"
  }
}
```

**API端点**: `POST /api/v1/memories`

**特点**:
- ✅ 内容包含完整的商品信息
- ✅ Metadata结构化存储，便于查询
- ✅ 使用Global Scope，所有Agent可见

#### 3.5 `add_customer_view_memory()`
**功能**: 添加客户浏览记忆（User Scope）

**特点**:
- 10%的商品会添加浏览记忆
- 使用User Scope，仅特定用户可见
- 记录浏览时长等信息

#### 3.6 `add_sales_analysis_memory()`
**功能**: 添加销售分析记忆（Agent Scope）

**特点**:
- 5%的商品会添加销售分析
- 使用Agent Scope，仅特定Agent可见
- 记录销售数据和增长趋势

### 4. 批量处理流程

```bash
for batch in $(seq 1 $TOTAL_BATCHES); do
    for i in $(seq 1 $BATCH_SIZE); do
        # 1. 生成商品ID: P000001, P000002, ...
        # 2. 随机选择分类、品牌、价格
        # 3. 生成商品数据
        # 4. 添加商品基础信息（Global Scope）
        # 5. 10%概率添加客户浏览记忆（User Scope）
        # 6. 5%概率添加销售分析记忆（Agent Scope）
    done
done
```

### 5. 数据统计

**预期生成**:
- 基础商品记忆: 1000条（Global Scope）
- 客户浏览记忆: ~100条（User Scope，10%概率）
- 销售分析记忆: ~50条（Agent Scope，5%概率）
- **总计**: ~1150条记忆

### 6. 脚本优点

1. ✅ **结构化数据**: 使用标准化的商品信息格式
2. ✅ **多Scope支持**: Global/User/Agent三种Scope
3. ✅ **批量处理**: 分批写入，避免API限流
4. ✅ **进度显示**: 实时显示处理进度
5. ✅ **错误处理**: 记录成功/失败数量
6. ✅ **性能统计**: 显示写入速率和总耗时

### 7. 潜在问题

1. ⚠️ **随机性**: 使用`$RANDOM`，每次运行结果不同
2. ⚠️ **API限流**: 虽然分批处理，但可能仍需要调整延迟
3. ⚠️ **错误恢复**: 失败的商品不会重试
4. ⚠️ **数据验证**: 没有验证添加后的数据是否正确

### 8. 改进建议

1. **添加重试机制**: 失败的商品自动重试
2. **数据验证**: 添加后验证数据是否正确写入
3. **可配置性**: 支持通过参数调整商品数量、批次大小等
4. **日志记录**: 记录详细的日志文件
5. **幂等性**: 支持重复运行而不产生重复数据

## 使用建议

### 执行前检查
1. ✅ 确认服务器运行正常
2. ✅ 确认API地址正确
3. ✅ 确认有足够的存储空间

### 执行步骤
```bash
# 1. 清理旧数据（可选）
./scripts/clear_all_memories.sh

# 2. 添加商品记忆
./scripts/add_product_memories.sh

# 3. 验证数据
./scripts/test_product_memories.sh
```

### 预期结果
- 成功写入 ~1000条基础商品记忆
- 成功写入 ~100条客户浏览记忆
- 成功写入 ~50条销售分析记忆
- 总耗时: 约2-5分钟（取决于API响应速度）

## 总结

这是一个设计良好的批量数据写入脚本，具有以下特点：
- ✅ 结构清晰，易于维护
- ✅ 支持多种Scope类型
- ✅ 包含进度和统计信息
- ✅ 错误处理基本完善

建议在实际使用前先测试小批量数据，确认无误后再执行完整批量写入。

