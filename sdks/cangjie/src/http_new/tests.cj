/*
 * Copyright (c) AgentMem Team 2024. All rights reserved.
 */

/**
 * @file tests.cj
 * HTTPå®¢æˆ·ç«¯å’ŒAPIæµ‹è¯•
 */

package agentmem_http

/// æµ‹è¯•HTTPå®¢æˆ·ç«¯åŸºæœ¬åŠŸèƒ½
public func testHttpClient(): Bool {
    println("\n=== æµ‹è¯•1: HTTPå®¢æˆ·ç«¯åŸºæœ¬åŠŸèƒ½ ===")
    
    let config = ClientConfig("http://localhost:8080")
    let client = AgentMemHttpClient(config)
    
    // æµ‹è¯•å¥åº·æ£€æŸ¥
    let result = client.get("/health")
    match (result) {
        | Ok(response) => {
            println("âœ… å¥åº·æ£€æŸ¥æˆåŠŸ: ${response}")
            return true
        }
        | Err(e) => {
            println("âŒ å¥åº·æ£€æŸ¥å¤±è´¥: ${e.getMessage()}")
            return false
        }
    }
}

/// æµ‹è¯•Memoryå¯¹è±¡åˆ›å»ºå’Œåºåˆ—åŒ–
public func testMemoryCreation(): Bool {
    println("\n=== æµ‹è¯•2: Memoryå¯¹è±¡åˆ›å»º ===")
    
    let memory = Memory.create("agent-1", "è¿™æ˜¯æµ‹è¯•è®°å¿†å†…å®¹")
    println("âœ… Memoryåˆ›å»ºæˆåŠŸ")
    println("  - ID: ${memory.id}")
    println("  - Agent ID: ${memory.agentId}")
    println("  - Content: ${memory.content}")
    println("  - Type: ${memory.memoryType.toString()}")
    
    let json = memory.toJson()
    println("âœ… JSONåºåˆ—åŒ–æˆåŠŸ: ${json}")
    
    return true
}

/// æµ‹è¯•æ·»åŠ è®°å¿†
public func testAddMemory(): Bool {
    println("\n=== æµ‹è¯•3: æ·»åŠ è®°å¿† ===")
    
    let config = ClientConfig("http://localhost:8080")
    let client = AgentMemHttpClient(config)
    let api = MemoryApi(client)
    
    let memory = Memory.create("agent-1", "é‡è¦çš„æµ‹è¯•è®°å¿†")
    let result = api.addMemory(memory)
    
    match (result) {
        | Ok(memoryId) => {
            println("âœ… æ·»åŠ è®°å¿†æˆåŠŸ, ID: ${memoryId}")
            return true
        }
        | Err(e) => {
            println("âŒ æ·»åŠ è®°å¿†å¤±è´¥: ${e.getMessage()}")
            return false
        }
    }
}

/// æµ‹è¯•è·å–è®°å¿†
public func testGetMemory(): Bool {
    println("\n=== æµ‹è¯•4: è·å–è®°å¿† ===")
    
    let config = ClientConfig("http://localhost:8080")
    let client = AgentMemHttpClient(config)
    let api = MemoryApi(client)
    
    let result = api.getMemory("mem-001")
    
    match (result) {
        | Ok(memory) => {
            println("âœ… è·å–è®°å¿†æˆåŠŸ")
            println("  - ID: ${memory.id}")
            println("  - Content: ${memory.content}")
            return true
        }
        | Err(e) => {
            println("âŒ è·å–è®°å¿†å¤±è´¥: ${e.getMessage()}")
            return false
        }
    }
}

/// æµ‹è¯•æœç´¢è®°å¿†
public func testSearchMemories(): Bool {
    println("\n=== æµ‹è¯•5: æœç´¢è®°å¿† ===")
    
    let config = ClientConfig("http://localhost:8080")
    let client = AgentMemHttpClient(config)
    let api = MemoryApi(client)
    
    let result = api.searchMemories("æµ‹è¯•", 10)
    
    match (result) {
        | Ok(results) => {
            println("âœ… æœç´¢æˆåŠŸ, æ‰¾åˆ° ${results.size()} æ¡è®°å¿†")
            return true
        }
        | Err(e) => {
            println("âŒ æœç´¢å¤±è´¥: ${e.getMessage()}")
            return false
        }
    }
}

/// æµ‹è¯•å®Œæ•´æµç¨‹
public func testFullWorkflow(): Bool {
    println("\n=== æµ‹è¯•6: å®Œæ•´å·¥ä½œæµç¨‹ ===")
    
    let config = ClientConfig("http://localhost:8080")
    let client = AgentMemHttpClient(config)
    let api = MemoryApi(client)
    
    // 1. æ·»åŠ è®°å¿†
    println("æ­¥éª¤1: æ·»åŠ è®°å¿†...")
    let memory = Memory.create("agent-1", "å·¥ä½œæµç¨‹æµ‹è¯•è®°å¿†")
    let addResult = api.addMemory(memory)
    
    var memoryId = ""
    match (addResult) {
        | Ok(id) => {
            memoryId = id
            println("âœ… æ·»åŠ æˆåŠŸ: ${id}")
        }
        | Err(e) => {
            println("âŒ æ·»åŠ å¤±è´¥: ${e.getMessage()}")
            return false
        }
    }
    
    // 2. è·å–è®°å¿†
    println("æ­¥éª¤2: è·å–è®°å¿†...")
    let getResult = api.getMemory(memoryId)
    match (getResult) {
        | Ok(mem) => {
            println("âœ… è·å–æˆåŠŸ: ${mem.content}")
        }
        | Err(e) => {
            println("âŒ è·å–å¤±è´¥: ${e.getMessage()}")
            return false
        }
    }
    
    // 3. æ›´æ–°è®°å¿†
    println("æ­¥éª¤3: æ›´æ–°è®°å¿†...")
    let updateResult = api.updateMemory(memoryId, "æ›´æ–°åçš„å†…å®¹")
    match (updateResult) {
        | Ok(_) => {
            println("âœ… æ›´æ–°æˆåŠŸ")
        }
        | Err(e) => {
            println("âŒ æ›´æ–°å¤±è´¥: ${e.getMessage()}")
            return false
        }
    }
    
    // 4. æœç´¢è®°å¿†
    println("æ­¥éª¤4: æœç´¢è®°å¿†...")
    let searchResult = api.searchMemories("æµ‹è¯•", 10)
    match (searchResult) {
        | Ok(results) => {
            println("âœ… æœç´¢æˆåŠŸ: æ‰¾åˆ° ${results.size()} æ¡")
        }
        | Err(e) => {
            println("âŒ æœç´¢å¤±è´¥: ${e.getMessage()}")
            return false
        }
    }
    
    // 5. åˆ é™¤è®°å¿†
    println("æ­¥éª¤5: åˆ é™¤è®°å¿†...")
    let deleteResult = api.deleteMemory(memoryId)
    match (deleteResult) {
        | Ok(_) => {
            println("âœ… åˆ é™¤æˆåŠŸ")
        }
        | Err(e) => {
            println("âŒ åˆ é™¤å¤±è´¥: ${e.getMessage()}")
            return false
        }
    }
    
    println("\nâœ… å®Œæ•´å·¥ä½œæµç¨‹æµ‹è¯•é€šè¿‡ï¼")
    return true
}

/// è¿è¡Œæ‰€æœ‰æµ‹è¯•
public func runAllTests() {
    println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    println("â•‘   AgentMem HTTP SDK æµ‹è¯•å¥—ä»¶        â•‘")
    println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    
    var passedTests = 0
    var totalTests = 6
    
    if (testHttpClient()) { passedTests += 1 }
    if (testMemoryCreation()) { passedTests += 1 }
    if (testAddMemory()) { passedTests += 1 }
    if (testGetMemory()) { passedTests += 1 }
    if (testSearchMemories()) { passedTests += 1 }
    if (testFullWorkflow()) { passedTests += 1 }
    
    println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
    println("â•‘         æµ‹è¯•ç»“æœç»Ÿè®¡                  â•‘")
    println("â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£")
    println("â•‘  é€šè¿‡: ${passedTests}/${totalTests}                       â•‘")
    println("â•‘  é€šè¿‡ç‡: ${(passedTests * 100) / totalTests}%                     â•‘")
    println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
    
    if (passedTests == totalTests) {
        println("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼HTTPæ–¹æ¡ˆéªŒè¯æˆåŠŸï¼")
    } else {
        println("\nâš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•")
    }
}

