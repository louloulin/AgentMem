# Logstash Pipeline 配置 - AgentMem 日志处理

input {
  # TCP 输入 - 用于接收应用日志
  tcp {
    port => 5000
    codec => json_lines
    tags => ["agentmem", "tcp"]
  }
  
  # UDP 输入 - 用于接收高吞吐量日志
  udp {
    port => 5000
    codec => json_lines
    tags => ["agentmem", "udp"]
  }
  
  # HTTP 输入 - 用于接收 HTTP POST 日志
  http {
    port => 8080
    codec => json
    tags => ["agentmem", "http"]
  }
  
  # 文件输入 - 用于读取日志文件（可选）
  # file {
  #   path => "/var/log/agentmem/*.log"
  #   start_position => "beginning"
  #   sincedb_path => "/dev/null"
  #   codec => json
  #   tags => ["agentmem", "file"]
  # }
}

filter {
  # 解析 JSON 日志
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      target => "parsed"
    }
  }
  
  # 提取时间戳
  if [parsed][timestamp] {
    date {
      match => ["[parsed][timestamp]", "ISO8601"]
      target => "@timestamp"
    }
  }
  
  # 提取日志级别
  if [parsed][level] {
    mutate {
      add_field => { "log_level" => "%{[parsed][level]}" }
    }
  }
  
  # 提取服务名称
  if [parsed][service_name] {
    mutate {
      add_field => { "service" => "%{[parsed][service_name]}" }
    }
  } else {
    mutate {
      add_field => { "service" => "agentmem" }
    }
  }
  
  # 提取 trace_id 和 span_id（用于分布式追踪关联）
  if [parsed][trace_id] {
    mutate {
      add_field => { "trace_id" => "%{[parsed][trace_id]}" }
    }
  }
  
  if [parsed][span_id] {
    mutate {
      add_field => { "span_id" => "%{[parsed][span_id]}" }
    }
  }
  
  # 提取错误信息
  if [parsed][error] {
    mutate {
      add_field => { "error_message" => "%{[parsed][error]}" }
      add_tag => ["error"]
    }
  }
  
  # 提取性能指标
  if [parsed][duration_ms] {
    mutate {
      add_field => { "duration_ms" => "%{[parsed][duration_ms]}" }
      convert => { "duration_ms" => "float" }
    }
  }
  
  # 提取用户信息
  if [parsed][user_id] {
    mutate {
      add_field => { "user_id" => "%{[parsed][user_id]}" }
    }
  }
  
  # 提取请求信息
  if [parsed][method] {
    mutate {
      add_field => { "http_method" => "%{[parsed][method]}" }
    }
  }
  
  if [parsed][endpoint] {
    mutate {
      add_field => { "http_endpoint" => "%{[parsed][endpoint]}" }
    }
  }
  
  if [parsed][status_code] {
    mutate {
      add_field => { "http_status" => "%{[parsed][status_code]}" }
      convert => { "http_status" => "integer" }
    }
  }
  
  # 添加环境标签
  mutate {
    add_field => {
      "environment" => "${ENVIRONMENT:production}"
      "cluster" => "${CLUSTER:agentmem}"
    }
  }
  
  # 移除原始 message 字段（已解析）
  if [parsed] {
    mutate {
      remove_field => ["message"]
    }
  }
  
  # GeoIP 解析（如果有 IP 地址）
  if [parsed][client_ip] {
    geoip {
      source => "[parsed][client_ip]"
      target => "geoip"
    }
  }
  
  # 用户代理解析
  if [parsed][user_agent] {
    useragent {
      source => "[parsed][user_agent]"
      target => "user_agent_parsed"
    }
  }
}

output {
  # 输出到 Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "agentmem-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
    
    # 模板配置
    template_name => "agentmem-logs"
    template_overwrite => true
    
    # 批量配置
    flush_size => 500
    idle_flush_time => 5
  }
  
  # 错误日志单独索引
  if "error" in [tags] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "agentmem-errors-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # 性能日志单独索引
  if [duration_ms] {
    elasticsearch {
      hosts => ["http://elasticsearch:9200"]
      index => "agentmem-performance-%{+YYYY.MM.dd}"
      document_type => "_doc"
    }
  }
  
  # 调试输出（开发环境）
  # stdout {
  #   codec => rubydebug
  # }
}

