{{/*
AgentMem Secret 定义
存储敏感配置数据（密码、密钥等）
*/}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "agentmem.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "agentmem.labels" . | nindent 4 }}
type: Opaque
data:
  {{- if .Values.config.jwtSecret }}
  # JWT 密钥
  jwt-secret: {{ .Values.config.jwtSecret | b64enc | quote }}
  {{- else }}
  # 自动生成的 JWT 密钥
  jwt-secret: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}
  
  {{- if .Values.config.apiKey }}
  # API 密钥
  api-key: {{ .Values.config.apiKey | b64enc | quote }}
  {{- else }}
  # 自动生成的 API 密钥
  api-key: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}
  
  {{- if .Values.config.encryptionKey }}
  # 数据加密密钥
  encryption-key: {{ .Values.config.encryptionKey | b64enc | quote }}
  {{- else }}
  # 自动生成的加密密钥
  encryption-key: {{ randAlphaNum 32 | b64enc | quote }}
  {{- end }}
  
  {{- if .Values.config.extraSecrets }}
  # 额外的密钥
  {{- range $key, $value := .Values.config.extraSecrets }}
  {{ $key }}: {{ $value | b64enc | quote }}
  {{- end }}
  {{- end }}
---
{{/*
外部数据库密码 Secret
仅在使用外部数据库时创建
*/}}
{{- if not .Values.postgresql.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "agentmem.fullname" . }}-externaldb
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "agentmem.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
type: Opaque
data:
  password: {{ .Values.externalDatabase.password | b64enc | quote }}
{{- end }}
---
{{/*
外部 Redis 密码 Secret
仅在使用外部 Redis 时创建
*/}}
{{- if not .Values.redis.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "agentmem.fullname" . }}-externalredis
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "agentmem.labels" . | nindent 4 }}
    app.kubernetes.io/component: cache
type: Opaque
data:
  password: {{ .Values.externalRedis.password | b64enc | quote }}
{{- end }}
---
{{/*
TLS 证书 Secret
用于 HTTPS 和内部服务间通信
*/}}
{{- if .Values.tls.enabled }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "agentmem.fullname" . }}-tls
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "agentmem.labels" . | nindent 4 }}
    app.kubernetes.io/component: tls
type: kubernetes.io/tls
data:
  {{- if and .Values.tls.cert .Values.tls.key }}
  tls.crt: {{ .Values.tls.cert | b64enc | quote }}
  tls.key: {{ .Values.tls.key | b64enc | quote }}
  {{- else }}
  # 注意：生产环境应使用真实证书
  # 这里仅用于开发/测试
  tls.crt: {{ "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURFekNDQWZ1Z0F3SUJBZ0lVRXhBTXBsRXhBTXBsRXhBTXBsRXhBTXBsRXhBd0RRWUpLb1pJaHZjTkFRRUwKQlFBd0dURVhNQlVHQTFVRUF3d09ZV2RsYm5SdFpXMHVaR1YyTUI0WERUSXlNREV3TVRBd01EQXdNRm9YRFRNeQpNREV3TVRBd01EQXdNRm93R1RFWE1CVUdBMVVFQXd3T1lXZGxiblJ0WlcwdVpHVjJNSUlCSWpBTkJna3Foa2lHCjl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF3MEFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUE=" | quote }}
  tls.key: {{ "LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRRERRQUFBQUFBQUFBQUEKQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQQo=" | quote }}
  {{- end }}
  {{- if .Values.tls.ca }}
  ca.crt: {{ .Values.tls.ca | b64enc | quote }}
  {{- end }}
{{- end }}

